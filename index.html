<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Devis intelligent — SARL BRUNO MIRA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg: #0b1220;
            --fg: #e5e7eb;
            --muted: #94a3b8;
            --card: #0f172a;
            --line: #1f2937;
            --accent: #22c55e;
            --danger: #ef4444;
        }
        
        * {
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
        }
        
        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: var(--bg);
            color: var(--fg);
        }
        
        a {
            color: var(--accent);
        }
        
        .container {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 16px;
        }
        
        header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
        }
        
        .logo {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            background: linear-gradient(135deg, #16a34a, #22c55e);
            font-weight: 800;
            color: #001b0a;
        }
        
        h1 {
            font-size: 22px;
            margin: 0;
        }
        
        .sub {
            color: var(--muted);
            font-size: 13px;
            margin-top: 2px;
        }
        
        .layout {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 16px;
        }
        
        @media (max-width: 980px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
        }
        
        .stepper {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        
        .step {
            padding: 8px 10px;
            border: 1px solid var(--line);
            border-radius: 12px;
            font-size: 13px;
            color: var(--muted);
            cursor: pointer;
        }
        
        .step.active {
            border-color: var(--accent);
            color: #042d17;
            background: rgba(34, 197, 94, 0.15);
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .row3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 720px) {
            .row, .row3 {
                grid-template-columns: 1fr;
            }
        }
        
        label {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
            display: block;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: #0b1220;
            color: var(--fg);
            font-size: 14px;
        }
        
        input[type="checkbox"], input[type="radio"] {
            width: auto;
        }
        
        .btn {
            cursor: pointer;
            font-weight: 800;
            letter-spacing: 0.2px;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #001b0a;
            border: 0;
        }
        
        .btn-ghost {
            background: transparent;
        }
        
        .muted {
            color: var(--muted);
            font-size: 12px;
        }
        
        .badge {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 4px 8px;
            border: 1px solid var(--line);
            border-radius: 999px;
            font-size: 12px;
            color: var(--muted);
        }
        
        .price {
            font-size: 28px;
            font-weight: 800;
        }
        
        .right {
            text-align: right;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            border-bottom: 1px dashed var(--line);
            font-size: 14px;
        }
        
        th {
            text-align: left;
            color: var(--muted);
        }
        
        .total {
            font-weight: 800;
        }
        
        .grid-gap {
            display: grid;
            gap: 12px;
        }
        
        .task-row {
            display: grid;
            grid-template-columns: 1.2fr 1.2fr 0.6fr 0.6fr auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .task-row button {
            width: auto;
            padding: 8px 12px;
        }
        
        .pill {
            padding: 4px 8px;
            border-radius: 10px;
            border: 1px solid var(--line);
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }
        
        .hr {
            height: 1px;
            background: var(--line);
            margin: 12px 0;
        }
        
        .alert {
            background: #0c1322;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">BM</div>
            <div>
                <h1>Devis intelligent — SARL BRUNO MIRA</h1>
                <div class="sub">Formulaire multi‑étapes · Tarification automatique par accès chantier, métiers et tâches · PDF & capture de lead</div>
            </div>
        </header>
        
        <div class="layout">
            <div>
                <div class="stepper" id="stepper"></div>
                
                <div id="step-1" class="card">
                    <h2 style="margin-top:0">1) Infos chantier</h2>
                    <div class="row">
                        <div>
                            <label>Adresse (ville)</label>
                            <input id="ville" placeholder="Montpellier, Béziers, Sète…"/>
                        </div>
                        <div>
                            <label>Date souhaitée</label>
                            <input id="date" type="date"/>
                        </div>
                    </div>
                    
                    <div class="row3" style="margin-top:10px">
                        <div>
                            <label>Étage</label>
                            <input id="etage" type="number" min="0" value="0"/>
                            <div class="muted">0 = RDC</div>
                        </div>
                        <div>
                            <label>Ascenseur</label>
                            <select id="ascenseur">
                                <option>Oui</option>
                                <option>Non</option>
                            </select>
                        </div>
                        <div>
                            <label>Portage depuis stationnement (m)</label>
                            <input id="portage" type="number" min="0" value="10"/>
                        </div>
                    </div>
                    
                    <div class="row3" style="margin-top:10px">
                        <div>
                            <label>Accès global</label>
                            <select id="acces">
                                <option value="simple">Simple</option>
                                <option value="normal" selected>Normal</option>
                                <option value="difficile">Difficile</option>
                            </select>
                            <div class="muted">Largeur/hauteur, couloirs, contraintes…</div>
                        </div>
                        <div>
                            <label>Stationnement</label>
                            <select id="stationnement">
                                <option value="facile">Facile</option>
                                <option value="moyen">Moyen</option>
                                <option value="difficile">Difficile</option>
                            </select>
                        </div>
                        <div>
                            <label>Frais de stationnement (€)</label>
                            <input id="parking_fees" type="number" min="0" value="0"/>
                        </div>
                    </div>
                    
                    <div class="row3" style="margin-top:10px">
                        <div>
                            <label>Accès engins (camion, mini‑pelle, benne)</label>
                            <select id="engins">
                                <option value="ok">Possible</option>
                                <option value="limité">Limité</option>
                                <option value="impossible">Impossible</option>
                            </select>
                        </div>
                        <div>
                            <label>Déchets à évacuer (m³)</label>
                            <input id="dechets" type="number" min="0" value="0"/>
                        </div>
                        <div>
                            <label>Complexité coordination</label>
                            <select id="complexite">
                                <option value="basse">Basse</option>
                                <option value="moyenne" selected>Moyenne</option>
                                <option value="haute">Haute</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="step-2" class="card" style="margin-top:12px">
                    <h2 style="margin-top:0">2) Métiers & tâches</h2>
                    <div class="grid-gap">
                        <div id="tasks"></div>
                        <button id="add-task" class="btn btn-ghost" type="button">+ Ajouter une tâche</button>
                        <div class="muted">Sélectionnez un métier, puis une tâche, indiquez la quantité.</div>
                    </div>
                </div>
                
                <div id="step-3" class="card" style="margin-top:12px">
                    <h2 style="margin-top:0">3) Options & TVA</h2>
                    <div class="row3">
                        <div>
                            <label>Urgence</label>
                            <select id="urgence">
                                <option value="non">Non</option>
                                <option value="oui">Oui (+10%)</option>
                            </select>
                        </div>
                        <div>
                            <label>Week‑end</label>
                            <select id="weekend">
                                <option value="non">Non</option>
                                <option value="oui">Oui (+25%)</option>
                            </select>
                        </div>
                        <div>
                            <label>Travail de nuit</label>
                            <select id="nuit">
                                <option value="non">Non</option>
                                <option value="oui">Oui (+20%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row" style="margin-top:10px">
                        <div>
                            <label>Pack / Marge</label>
                            <select id="pack">
                                <option value="standard">Standard (x1.00)</option>
                                <option value="confort">Confort (x1.12)</option>
                                <option value="premium">Premium (x1.25)</option>
                            </select>
                        </div>
                        <div>
                            <label>TVA automatique</label>
                            <select id="tva_mode">
                                <option value="auto">Auto (5,5 / 10 / 20)</option>
                                <option value="5.5">Forcer 5,5%</option>
                                <option value="10">Forcer 10%</option>
                                <option value="20">Forcer 20%</option>
                            </select>
                            <div class="muted">Auto : 5,5% si uniquement tâches éligibles, sinon 10% si logement > 2 ans, sinon 20%.</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:10px">
                        <label><input id="logement_2ans" type="checkbox" checked/> Logement achevé depuis plus de 2 ans</label>
                    </div>
                </div>
                
                <div id="step-4" class="card" style="margin-top:12px">
                    <h2 style="margin-top:0">4) Coordonnées</h2>
                    <div class="row3">
                        <div>
                            <label>Nom</label>
                            <input id="name" placeholder="Nom Prénom"/>
                        </div>
                        <div>
                            <label>Email</label>
                            <input id="email" type="email" placeholder="vous@email.fr"/>
                        </div>
                        <div>
                            <label>Téléphone</label>
                            <input id="phone" type="tel" placeholder="06 12 34 56 78"/>
                        </div>
                    </div>
                    
                    <div style="margin-top:10px">
                        <label>Commentaire</label>
                        <textarea id="comment" rows="3" placeholder="Infos complémentaires, photos (lien), contraintes spécifiques…"></textarea>
                    </div>
                    
                    <div class="hr"></div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button id="btn-prev" class="btn btn-ghost" type="button">← Précédent</button>
                        <button id="btn-next" class="btn btn-primary" type="button">Voir le récapitulatif →</button>
                    </div>
                </div>
                
                <div id="step-5" class="card" style="margin-top:12px;display:none">
                    <h2 style="margin-top:0">5) Récapitulatif & envoi</h2>
                    <div id="recap"></div>
                    <div class="hr"></div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button id="btn-pdf" class="btn btn-ghost" type="button">Télécharger le PDF</button>
                        <button id="btn-send" class="btn btn-primary" type="button">Envoyer & être rappelé</button>
                        <button id="btn-edit" class="btn btn-ghost" type="button">← Modifier</button>
                    </div>
                    <p class="muted" style="margin-top:8px">En envoyant, vous acceptez d'être recontacté. Données stockées de façon sécurisée. Droit de rectification et suppression sur demande.</p>
                </div>
            </div>
            
            <div class="card" aria-live="polite" aria-atomic="true">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                    <h2 style="margin:0">Estimation en temps réel</h2>
                    <span class="badge" id="count-tasks">0 tâche</span>
                </div>
                
                <div class="row" style="margin-top:8px">
                    <div>
                        <div class="muted">Total estimatif HT</div>
                        <div class="price" id="total-ht">—</div>
                    </div>
                    <div>
                        <div class="muted">Total estimatif TTC</div>
                        <div class="price" id="total-ttc">—</div>
                    </div>
                </div>

                <div class="muted" style="margin-top:8px">Durée estimée : <span id="duration">—</span></div>

                <table style="margin-top:10px">
                    <thead>
                        <tr>
                            <th>Détail</th>
                            <th class="right">HT</th>
                        </tr>
                    </thead>
                    <tbody id="rows"></tbody>
                    <tfoot>
                        <tr>
                            <td class="total">Total HT</td>
                            <td class="right total" id="f-total-ht">—</td>
                        </tr>
                        <tr>
                            <td>TVA <span id="tva-rate">—</span></td>
                            <td class="right" id="tva-amt">—</td>
                        </tr>
                        <tr>
                            <td class="total">Total TTC</td>
                            <td class="right total" id="f-total-ttc">—</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="alert" style="margin-top:12px">
                    Estimation indicative. Visite technique et devis signé nécessaires pour valider prix, quantités et délais. TVA réduite sous conditions.
                </div>
                
                <div class="muted" style="margin-top:10px">
                    SARL BRUNO MIRA — SIREN 000 000 000 — RCS XXX — TVA FRXX — RC & décennale n° XXXXX — 34980 Combaillaux — contact@exemple.fr — 04 xx xx xx xx. Validité 30 jours.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CATALOG = {
            "Maçonnerie": [
                { id: 'dalle_beton', label: 'Dalle béton', unit: 'm²', rate: 95, min: 800, hours: 0.5 },
                { id: 'ouverture_porteur', label: 'Ouverture mur porteur (IPN inclus)', unit: 'forfait', rate: 2800, min: 2800, hours: 35 },
                { id: 'demolition_cloison', label: 'Démolition cloison', unit: 'm²', rate: 35, min: 300, hours: 0.15 },
                { id: 'mur_agglo', label: 'Mur agglos 20', unit: 'm²', rate: 85, min: 600, hours: 0.6 },
                { id: 'chape_liquide', label: 'Chape liquide', unit: 'm²', rate: 22, min: 400, hours: 0.1 },
                { id: 'seuil_beton', label: 'Seuil béton', unit: 'ml', rate: 60, min: 240, hours: 0.4 },
                { id: 'fondations_semelles', label: 'Fondations semelles filantes', unit: 'ml', rate: 120, min: 600, hours: 0.8 },
                { id: 'muret_cloture', label: 'Muret de clôture', unit: 'ml', rate: 95, min: 500, hours: 0.6 },
                { id: 'ragreage_sol', label: 'Ragréage sol', unit: 'm²', rate: 18, min: 250, hours: 0.1 }
            ],
            "Plomberie": [
                { id: 'reseau_ecs', label: 'Réseau eau chaude/froide', unit: 'ml', rate: 42, min: 350, hours: 0.3 },
                { id: 'sdb_pack', label: 'Salle de bains — pack (hors meubles)', unit: 'm²', rate: 280, min: 2500, hours: 0.8 },
                { id: 'wc_suspendu', label: 'WC suspendu — pose', unit: 'forfait', rate: 420, min: 420, hours: 8 },
                { id: 'chauffe_eau_200', label: 'Chauffe‑eau 200 L — pose', unit: 'forfait', rate: 380, min: 380, hours: 6 },
                { id: 'evac_eu', label: 'Évacuation EU', unit: 'ml', rate: 30, min: 180, hours: 0.2 },
                { id: 'receveur_douche', label: 'Receveur de douche — pose', unit: 'forfait', rate: 380, min: 380, hours: 7 },
                { id: 'chaudiere_gaz', label: 'Chaudière gaz condensation — pose', unit: 'forfait', rate: 2500, min: 2500, hours: 30 },
                { id: 'raccordement_evier', label: 'Raccordement évier cuisine', unit: 'forfait', rate: 180, min: 180, hours: 3 }
            ],
            "Électricité": [
                { id: 'renov_t2', label: 'Rénovation électrique T2', unit: 'forfait', rate: 3200, min: 3200, hours: 40 },
                { id: 'prise', label: 'Ajout prise', unit: 'u', rate: 55, min: 165, hours: 1 },
                { id: 'spots', label: 'Spots encastrés', unit: 'u', rate: 65, min: 195, hours: 0.8 },
                { id: 'tableau', label: 'Remplacement tableau', unit: 'forfait', rate: 450, min: 450, hours: 8 },
                { id: 'point_lumineux', label: 'Point lumineux', unit: 'u', rate: 70, min: 140, hours: 0.5 },
                { id: 'vmc_simple', label: 'VMC simple flux', unit: 'forfait', rate: 850, min: 850, hours: 16 },
                { id: 'prise_exterieure', label: 'Prise extérieure étanche', unit: 'u', rate: 80, min: 160, hours: 0.8 },
                { id: 'mise_terre', label: 'Mise à la terre complète', unit: 'forfait', rate: 650, min: 650, hours: 14 }
            ],
            "Carrelage": [
                { id: 'sol_interieur', label: 'Carrelage sol intérieur', unit: 'm²', rate: 55, min: 500, hours: 0.3 },
                { id: 'terrasse', label: 'Terrasse carrelée', unit: 'm²', rate: 75, min: 800, hours: 0.4 },
                { id: 'credence', label: 'Crédence cuisine', unit: 'm²', rate: 85, min: 200, hours: 0.2 },
                { id: 'faience', label: 'Faïence murale', unit: 'm²', rate: 45, min: 300, hours: 0.25 },
                { id: 'plinthes_carrelage', label: 'Plinthes assorties', unit: 'ml', rate: 15, min: 120, hours: 0.05 },
                { id: 'escalier_carrelage', label: 'Escalier carrelé', unit: 'u', rate: 110, min: 330, hours: 2 },
                { id: 'pose_mosaique', label: 'Pose mosaïque', unit: 'm²', rate: 95, min: 200, hours: 0.3 }
            ],
            "Peinture": [
                { id: 'murs_plafonds', label: 'Peinture murs & plafonds', unit: 'm²', rate: 14, min: 300, hours: 0.15 },
                { id: 'boiseries_laque', label: 'Boiseries — laque', unit: 'm²', rate: 22, min: 220, hours: 0.2 },
                { id: 'enduit_lissage', label: 'Enduit de lissage', unit: 'm²', rate: 12, min: 180, hours: 0.15 },
                { id: 'peinture_facade', label: 'Peinture de façade', unit: 'm²', rate: 28, min: 600, hours: 0.25 },
                { id: 'papier_peint', label: 'Pose papier peint', unit: 'm²', rate: 20, min: 200, hours: 0.2 },
                { id: 'peinture_anti_humidite', label: 'Peinture anti-humidité', unit: 'm²', rate: 18, min: 180, hours: 0.18 }
            ],
            "Menuiserie": [
                { id: 'porte_interieure', label: 'Porte intérieure — pose', unit: 'u', rate: 110, min: 220, hours: 3 },
                { id: 'fenetre_pvc', label: 'Fenêtre PVC double vitrage', unit: 'u', rate: 450, min: 450, hours: 8 },
                { id: 'volet_roulant', label: 'Volet roulant motorisé', unit: 'u', rate: 500, min: 500, hours: 5 },
                { id: 'parquet_flottant', label: 'Parquet flottant', unit: 'm²', rate: 35, min: 300, hours: 0.25 },
                { id: 'placard_sur_mesure', label: 'Placard sur mesure', unit: 'ml', rate: 300, min: 600, hours: 6 }
            ],
            "Plâtrerie": [
                { id: 'cloison_ba13', label: 'Cloison BA13 sur ossature', unit: 'm²', rate: 45, min: 350, hours: 0.3 },
                { id: 'doublage_isolant', label: 'Doublage isolant', unit: 'm²', rate: 40, min: 320, hours: 0.25 },
                { id: 'plafond_suspendu', label: 'Plafond suspendu', unit: 'm²', rate: 55, min: 400, hours: 0.4 },
                { id: 'corniche_staff', label: 'Corniche staff', unit: 'ml', rate: 25, min: 150, hours: 0.1 },
                { id: 'joint_placo', label: 'Joint placo', unit: 'ml', rate: 3, min: 100, hours: 0.02 }
            ],
            "Couverture": [
                { id: 'toiture_tuile', label: 'Toiture tuiles neuve', unit: 'm²', rate: 85, min: 1500, hours: 0.6 },
                { id: 'reparation_fuite', label: 'Réparation fuite toiture', unit: 'forfait', rate: 450, min: 450, hours: 6 },
                { id: 'pose_gouttiere', label: 'Pose gouttière zinc', unit: 'ml', rate: 35, min: 210, hours: 0.25 },
                { id: 'demoussage_toiture', label: 'Démoussage toiture', unit: 'm²', rate: 12, min: 300, hours: 0.1 },
                { id: 'reprise_faitiere', label: 'Reprise faîtière', unit: 'ml', rate: 65, min: 325, hours: 0.4 }
            ],
            "Isolation": [
                { id: 'isolation_combles', label: 'Isolation combles laine soufflée', unit: 'm²', rate: 25, min: 500, hours: 0.2 },
                { id: 'isolation_murs', label: 'Isolation murs intérieurs', unit: 'm²', rate: 35, min: 400, hours: 0.25 },
                { id: 'isolation_plancher', label: 'Isolation plancher bas', unit: 'm²', rate: 30, min: 300, hours: 0.25 },
                { id: 'isolation_exterieure', label: 'Isolation extérieure polystyrène', unit: 'm²', rate: 95, min: 1500, hours: 0.6 },
                { id: 'etancheite_air', label: "Étanchéité à l'air — membrane", unit: 'm²', rate: 18, min: 200, hours: 0.1 }
            ],
            "Climatisation": [
                { id: 'clim_monosplit', label: 'Climatiseur monosplit — pose', unit: 'forfait', rate: 1100, min: 1100, hours: 18 },
                { id: 'clim_multisplit', label: 'Climatiseur multisplit — pose', unit: 'forfait', rate: 2200, min: 2200, hours: 40 },
                { id: 'entretien_clim', label: 'Entretien climatisation', unit: 'forfait', rate: 120, min: 120, hours: 2 },
                { id: 'pompe_a_chaleur', label: 'Pompe à chaleur air/eau', unit: 'forfait', rate: 8500, min: 8500, hours: 80 },
                { id: 'vmc_double_flux', label: 'VMC double flux', unit: 'forfait', rate: 3200, min: 3200, hours: 35 }
            ],
            "Terrassement": [
                { id: 'decaissement', label: 'Décaissement terrain', unit: 'm²', rate: 12, min: 400, hours: 0.2 },
                { id: 'tranchee_technique', label: 'Tranchée technique', unit: 'ml', rate: 30, min: 300, hours: 0.25 },
                { id: 'drainage_peripherique', label: 'Drainage périphérique', unit: 'ml', rate: 40, min: 400, hours: 0.4 },
                { id: 'evacuation_deblais', label: 'Évacuation des déblais', unit: 'm²', rate: 20, min: 300, hours: 0.3 },
                { id: 'remblaiement', label: 'Remblaiement', unit: 'm²', rate: 8, min: 200, hours: 0.1 }
            ]
        };

        // Tâches éligibles à la TVA réduite (5,5 %)
        const TVA55_TASKS = new Set([
            'chauffe_eau_200',
            'chaudiere_gaz',
            'isolation_combles',
            'isolation_murs',
            'isolation_plancher',
            'isolation_exterieure',
            'etancheite_air',
            'pompe_a_chaleur',
            'vmc_double_flux'
        ]);

        // Distances approximatives depuis Vailhauquès (km aller simple)
        const CITY_DISTANCES = {
            montpellier: 15,
            beziers: 70,
            sete: 45,
            nimes: 85,
            agde: 75
        };
        const BASE_COORDS = { lat: 43.65, lon: 3.72 }; // Vailhauquès approximatif
        const FUEL_COST_PER_KM = 0.5;
        async function getDistanceFromCity(city) {
            const key = (city || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            if (CITY_DISTANCES[key]) return CITY_DISTANCES[key];
            try {
                const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(city)}&limit=1&autocomplete=0&lat=${BASE_COORDS.lat}&lon=${BASE_COORDS.lon}`);
                if (res.ok) {
                    const data = await res.json();
                    const feature = data.features && data.features[0];
                    if (feature) {
                        const [lon, lat] = feature.geometry.coordinates;
                        const R = 6371; // Rayon terrestre en km
                        const dLat = (lat - BASE_COORDS.lat) * Math.PI / 180;
                        const dLon = (lon - BASE_COORDS.lon) * Math.PI / 180;
                        const a = Math.sin(dLat / 2) ** 2 + Math.cos(BASE_COORDS.lat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        const dist = Math.round(R * c);
                        CITY_DISTANCES[key] = dist;
                        return dist;
                    }
                }
            } catch (e) {
                console.error('Erreur distance', e);
            }
            return 20;
        }

        // Variables globales
        let currentStep = 0;
        // Helper functions
        const formatEUR = n => (n || 0).toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
        const byId = id => document.getElementById(id);

        // Fonction pour créer une ligne de tâche
        function addTaskRow() {
            const tasksContainer = byId('tasks');
            const row = document.createElement('div');
            row.className = 'task-row';

            // Sélection du métier
            const tradeSelect = document.createElement('select');
            tradeSelect.className = 'trade-select';
            tradeSelect.innerHTML = '<option value="">Choisir un métier...</option>';
            Object.keys(CATALOG).forEach(trade => {
                const option = document.createElement('option');
                option.value = trade;
                option.textContent = trade;
                tradeSelect.appendChild(option);
            });

            // Sélection de la tâche
            const taskSelect = document.createElement('select');
            taskSelect.className = 'task-select';
            taskSelect.innerHTML = '<option value="">Choisir une tâche...</option>';
            taskSelect.disabled = true;

            // Quantité
            const qtyInput = document.createElement('input');
            qtyInput.className = 'qty-input';
            qtyInput.type = 'number';
            qtyInput.min = '0';
            qtyInput.value = '1';
            qtyInput.placeholder = 'Qté';

            // Unité
            const unitDiv = document.createElement('div');
            unitDiv.className = 'pill';
            unitDiv.textContent = '—';

            // Bouton supprimer
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-ghost';
            deleteBtn.type = 'button';
            deleteBtn.textContent = '🗑️';

            // Event listeners
            tradeSelect.addEventListener('change', function() {
                const selectedTrade = this.value;
                taskSelect.innerHTML = '<option value="">Choisir une tâche...</option>';

                if (selectedTrade && CATALOG[selectedTrade]) {
                    taskSelect.disabled = false;
                    CATALOG[selectedTrade].forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.id;
                        option.textContent = task.label;
                        option.dataset.unit = task.unit;
                        option.dataset.rate = task.rate;
                        option.dataset.min = task.min;
                        option.dataset.hours = task.hours;
                        option.dataset.tva55 = TVA55_TASKS.has(task.id) ? '1' : '0';
                        taskSelect.appendChild(option);
                    });
                } else {
                    taskSelect.disabled = true;
                }

                unitDiv.textContent = '—';
                qtyInput.disabled = false;
                qtyInput.value = '1';
                updatePricing();
            });

            taskSelect.addEventListener('change', function() {
                const selectedOption = this.selectedOptions[0];
                if (selectedOption && selectedOption.dataset.unit) {
                    unitDiv.textContent = selectedOption.dataset.unit;

                    // Si c'est un forfait, mettre la quantité à 1 et la désactiver
                    if (selectedOption.dataset.unit === 'forfait') {
                        qtyInput.value = '1';
                        qtyInput.disabled = true;
                    } else {
                        qtyInput.disabled = false;
                    }
                } else {
                    unitDiv.textContent = '—';
                    qtyInput.disabled = false;
                }
                updatePricing();
            });

            qtyInput.addEventListener('input', updatePricing);

            deleteBtn.addEventListener('click', function() {
                row.remove();
                updatePricing();
            });

            // Assembler la ligne
            row.appendChild(tradeSelect);
            row.appendChild(taskSelect);
            row.appendChild(qtyInput);
            row.appendChild(unitDiv);
            row.appendChild(deleteBtn);

            tasksContainer.appendChild(row);
            updatePricing();
        }

        // Fonction pour lire toutes les tâches
        function readTasks() {
            const taskRows = document.querySelectorAll('.task-row');
            const result = [];

            taskRows.forEach(row => {
                const tradeSelect = row.querySelector('.trade-select');
                const taskSelect = row.querySelector('.task-select');
                const qtyInput = row.querySelector('.qty-input');

                const trade = tradeSelect.value;
                const taskId = taskSelect.value;
                const qty = parseFloat(qtyInput.value) || 0;

                if (trade && taskId && qty > 0) {
                    const taskOption = taskSelect.selectedOptions[0];
                    if (taskOption) {
                        result.push({
                            trade: trade,
                            taskId: taskId,
                            label: taskOption.textContent,
                            unit: taskOption.dataset.unit,
                            rate: parseFloat(taskOption.dataset.rate),
                            min: parseFloat(taskOption.dataset.min),
                            hours: parseFloat(taskOption.dataset.hours),
                            qty: qty,
                            tva55: taskOption.dataset.tva55 === '1'
                        });
                    }
                }
            });

            return result;
        }

        // Fonction de calcul des prix
        async function updatePricing() {
            const tasks = readTasks();
            let tasksTotal = 0;
            let totalHours = 0;
            const rows = [];

            // Taux de majoration appliqué aux tâches en fonction des options
            let optionRate = 0;
            if (byId('urgence').value === 'oui') optionRate += 0.10;
            if (byId('weekend').value === 'oui') optionRate += 0.25;
            if (byId('nuit').value === 'oui') optionRate += 0.20;
            const pack = byId('pack').value;
            if (pack === 'confort') optionRate += 0.12;
            else if (pack === 'premium') optionRate += 0.25;

            // Calcul du prix des tâches avec majoration éventuelle
            tasks.forEach(task => {
                let price = 0;

                switch (task.unit) {
                    case 'm²':
                    case 'ml':
                    case 'u':
                        price = task.rate * task.qty;
                        break;
                    case 'forfait':
                        price = task.rate;
                        break;
                }

                // Appliquer le minimum
                if (task.min) {
                    price = Math.max(price, task.min);
                }

                // Répartir les options sur les tâches
                price *= (1 + optionRate);

                const hours = task.unit === 'forfait' ? task.hours : task.hours * task.qty;
                totalHours += hours;
                tasksTotal += price;
                rows.push({ description: `${task.trade} — ${task.label} (${task.qty} ${task.unit})`, price });
            });

            // Durée estimée du chantier
            const workDays = totalHours / 7;
            const days = totalHours > 0 ? Math.ceil(workDays) : 0;

            // Coût des trajets basé sur la durée réelle
            const distance = await getDistanceFromCity(byId('ville').value);
            const travelCost = distance * 2 * workDays * FUEL_COST_PER_KM;
            if (travelCost > 0 && tasksTotal > 0) {
                rows.forEach(row => {
                    const share = (row.price / tasksTotal) * travelCost;
                    row.price += share;
                });
                tasksTotal += travelCost;
            }

            let totalHT = tasksTotal;

            // TVA
            const tvaMode = byId('tva_mode').value;
            const logement2ans = byId('logement_2ans').checked;
            let tvaRate;

            if (tvaMode === 'auto') {
                const all55 = tasks.length > 0 && tasks.every(t => t.tva55);
                if (all55) {
                    tvaRate = 0.055;
                } else if (logement2ans) {
                    tvaRate = 0.10;
                } else {
                    tvaRate = 0.20;
                }
            } else {
                tvaRate = parseFloat(tvaMode) / 100;
            }

            const tvaAmount = totalHT * tvaRate;
            const totalTTC = totalHT + tvaAmount;

            // Mise à jour de l'affichage
            byId('total-ht').textContent = formatEUR(totalHT);
            byId('total-ttc').textContent = formatEUR(totalTTC);
            byId('f-total-ht').textContent = formatEUR(totalHT);
            byId('f-total-ttc').textContent = formatEUR(totalTTC);
            byId('tva-rate').textContent = `${(tvaRate * 100).toFixed(1).replace(/\.0$/, '')}%`;
            byId('tva-amt').textContent = formatEUR(tvaAmount);
            byId('count-tasks').textContent = `${tasks.length} ${tasks.length > 1 ? 'tâches' : 'tâche'}`;
            byId('duration').textContent = days > 0 ? `${days} ${days > 1 ? 'jours' : 'jour'}` : '—';

            // Mise à jour du tableau détaillé
            const rowsContainer = byId('rows');
            rowsContainer.innerHTML = '';

            rows.forEach(row => {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td');
                td1.textContent = row.description;
                const td2 = document.createElement('td');
                td2.className = 'right';
                td2.textContent = formatEUR(row.price);
                tr.appendChild(td1);
                tr.appendChild(td2);
                rowsContainer.appendChild(tr);
            });
        }

        // Initialisation
        byId('add-task').addEventListener('click', addTaskRow);
        const optionIds = ['urgence', 'weekend', 'nuit', 'pack', 'tva_mode'];
        optionIds.forEach(id => {
            const el = byId(id);
            if (el) el.addEventListener('change', updatePricing);
        });
        const logement2ansEl = byId('logement_2ans');
        if (logement2ansEl) logement2ansEl.addEventListener('change', updatePricing);
        const villeEl = byId('ville');
        if (villeEl) villeEl.addEventListener('input', updatePricing);
        addTaskRow();

        // Génération du récapitulatif
        function buildRecap() {
            const recap = byId('recap');
            const tasks = readTasks();
            let html = '<h3>Coordonnées</h3>';
            html += `<p>${byId('name').value} — ${byId('email').value} — ${byId('phone').value}</p>`;
            const comment = byId('comment').value.trim();
            if (comment) {
                html += `<p>${comment}</p>`;
            }
            if (tasks.length > 0) {
                html += '<h3>Tâches</h3><ul>';
                tasks.forEach(t => {
                    html += `<li>${t.trade} — ${t.label} (${t.qty} ${t.unit})</li>`;
                });
                html += '</ul>';
            }
            html += `<p><strong>Total HT :</strong> ${byId('f-total-ht').textContent}<br><strong>Total TTC :</strong> ${byId('f-total-ttc').textContent} (TVA ${byId('tva-rate').textContent})</p>`;
            recap.innerHTML = html;
        }

        // Navigation vers le récapitulatif
        const btnNext = byId('btn-next');
        if (btnNext) {
            btnNext.addEventListener('click', async function () {
                await updatePricing();
                buildRecap();
                const step5 = byId('step-5');
                step5.style.display = 'block';
                step5.scrollIntoView({ behavior: 'smooth' });
            });
        }
        const btnEdit = byId('btn-edit');
        if (btnEdit) {
            btnEdit.addEventListener('click', function () {
                byId('step-5').style.display = 'none';
                byId('step-4').scrollIntoView({ behavior: 'smooth' });
            });
        }

    </script>
</body>
</html>
