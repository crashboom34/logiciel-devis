<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Devis intelligent</title>
    <link rel="stylesheet" href="saas.css"/>
    <script defer src="subtasks.js"></script>
    <script>
        let user = JSON.parse(localStorage.getItem('user') || 'null');

        if (!user || !user.plan) {
            user = { plan: 'starter' };
            localStorage.setItem('user', JSON.stringify(user));
        }

        const planParam = new URLSearchParams(window.location.search).get('plan');
        if (planParam) {
            user.plan = planParam;
            localStorage.setItem('user', JSON.stringify(user));
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg: #0b1220;
            --bg-grad: #1a2333;
            --fg: #f1f5f9;
            --muted: #9ca3af;
            --card: #0f172a;
            --line: #1f2937;
            --accent: #22c55e;
            --danger: #ef4444;
        }

        html[data-theme='light'] {
            --bg: #f9fafb;
            --bg-grad: #f3f4f6;
            --fg: #111827;
            --muted: #374151;
            --card: #ffffff;
            --line: #d1d5db;
            --accent: #16a34a;
            --danger: #dc2626;
        }
        
        * {
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
        }
        
        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: radial-gradient(circle at 25% 25%, var(--bg-grad), var(--bg));
            color: var(--fg);
            line-height: 1.6;
        }
        
        a {
            color: var(--accent);
        }

        #progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--line);
            z-index: 1000;
        }

        #progress-bar {
            height: 100%;
            width: 0;
            background: var(--accent);
            transition: width 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 16px;
        }
        
        header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
        }
        
        .logo {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            background: linear-gradient(135deg, #16a34a, #22c55e);
            font-weight: 800;
            color: #001b0a;
        }
        
        h1 {
            font-size: 22px;
            margin: 0;
        }
        
        .sub {
            color: var(--muted);
            font-size: 13px;
            margin-top: 2px;
        }
        
        .layout {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 16px;
        }
        
        @media (max-width: 980px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: var(--card);
            backdrop-filter: blur(8px);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        }
        
        .stepper {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        
        .step {
            padding: 8px 10px;
            border: 1px solid var(--line);
            border-radius: 12px;
            font-size: 13px;
            color: var(--muted);
            cursor: pointer;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .step:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--fg);
        }
        
        .step.active {
            border-color: var(--accent);
            color: #042d17;
            background: rgba(34, 197, 94, 0.15);
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .row3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 720px) {
            .row, .row3 {
                grid-template-columns: 1fr;
            }
        }
        
        label {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
            display: block;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: var(--card);
            color: var(--fg);
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
            background: var(--bg);
        }
        
        input[type="checkbox"], input[type="radio"] {
            width: auto;
        }
        
        .btn {
            cursor: pointer;
            font-weight: 800;
            letter-spacing: 0.2px;
            transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            border-radius: 8px;
            padding: 8px 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: #001b0a;
            border: 0;
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.6);
            transform: translateY(-1px);
        }
        
        .btn-ghost {
            background: transparent;
            border: 1px solid var(--line);
            color: var(--fg);
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-1px);
        }
        
        .muted {
            color: var(--muted);
            font-size: 12px;
        }
        
        .badge {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 4px 8px;
            border: 1px solid var(--line);
            border-radius: 999px;
            font-size: 12px;
            color: var(--muted);
        }
        
        .price {
            font-size: 28px;
            font-weight: 800;
        }
        
        .right {
            text-align: right;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            border-bottom: 1px dashed var(--line);
            font-size: 14px;
        }
        
        th {
            text-align: left;
            color: var(--muted);
        }
        
        .total {
            font-weight: 800;
        }
        
        .grid-gap {
            display: grid;
            gap: 12px;
        }
        
        .task-row {
            display: grid;
            grid-template-columns: 1.2fr 1.2fr 0.6fr 0.6fr 1.2fr auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .task-row button {
            width: auto;
            padding: 8px 12px;
        }

        .task-row.manual {
            grid-template-columns: 1.2fr 1.2fr 0.6fr 0.6fr 0.6fr 1.2fr auto;
        }

        .task-block {
            margin-bottom: 8px;
        }

        .subtasks {
            margin: 12px 0 0;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(148, 163, 184, 0.12);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        html[data-theme='light'] .subtasks {
            background: rgba(15, 23, 42, 0.05);
        }

        .subtasks:empty {
            display: none;
        }

        .subtasks:not(:empty)::before {
            content: 'Sous-t√¢ches';
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--muted);
        }

        .subtask-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: rgba(15, 23, 42, 0.35);
        }

        html[data-theme='light'] .subtask-row {
            background: rgba(148, 163, 184, 0.12);
        }

        .subtask-row input {
            flex: 1;
            padding: 10px;
        }

        @media (max-width: 600px) {
            .task-row {
                grid-template-columns: 1fr 1fr;
            }
            .task-row .trade-select,
            .task-row .task-select,
            .task-row .detail-input,
            .task-row button {
                grid-column: span 2;
            }
        }

        .pill {
            padding: 4px 8px;
            border-radius: 10px;
            border: 1px solid var(--line);
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }
        
        .hr {
            height: 1px;
            background: var(--line);
            margin: 12px 0;
        }
        
        .alert {
            background: #0c1322;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
        }

        #recap {
            line-height: 1.6;
            font-size: 15px;
        }

        #recap h3 {
            margin-top: 20px;
            font-size: 16px;
            border-bottom: 1px solid var(--line);
            padding-bottom: 4px;
        }

        #recap ul {
            margin: 6px 0 12px 16px;
            padding: 0;
        }

        #recap li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div class="banner">1 mois gratuit sur l'offre Starter</div>
    <nav class="navbar">
        <div><a href="pricing.html">Tarifs</a></div>
        <div><a id="nav-auth"></a></div>
    </nav>
    <div id="progress-container"><div id="progress-bar"></div></div>
    <div class="container">
        <header>
            <div class="logo" id="company-logo">BM</div>
            <div>
                <h1>Devis intelligent ‚Äî <span id="company-title">SARL BRUNO MIRA</span></h1>
                <div class="sub">Formulaire multi‚Äë√©tapes ¬∑ Tarification automatique par acc√®s chantier, m√©tiers et t√¢ches ¬∑ PDF &amp; capture de lead</div>
                <div class="actions" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                    <button id="btn-company" class="btn btn-ghost" type="button">Infos entreprise</button>
                    <button id="theme-toggle" class="btn btn-ghost" type="button">Mode clair</button>
                </div>
            </div>
        </header>
        <div class="layout">
            <div>
                <div id="company-settings" class="card" style="margin-bottom:12px;display:none">
                    <h2 style="margin-top:0">Informations entreprise</h2>
                    <div class="row3">
                        <div><label>Nom</label><input id="c-name"/></div>
                        <div><label>Email</label><input id="c-email" type="email"/></div>
                        <div><label>T√©l√©phone</label><input id="c-phone"/></div>
                    </div>
                    <div class="row3" style="margin-top:10px">
                        <div><label>Adresse</label><input id="c-address"/></div>
                        <div><label>SIREN</label><input id="c-siren"/></div>
                        <div><label>SIRET</label><input id="c-siret"/></div>
                    </div>
                    <div class="row3" style="margin-top:10px">
                        <div><label>RCS</label><input id="c-rcs"/></div>
                        <div><label>TVA</label><input id="c-tva"/></div>
                        <div><label>Assurance</label><input id="c-assurance"/></div>
                    </div>
                    <div style="margin-top:10px;text-align:right">
                        <button id="btn-save-company" class="btn btn-primary" type="button">Enregistrer</button>
                    </div>
                </div>
                <div class="stepper" id="stepper"></div>
                
                <div id="step-1" class="card">
                    <h2 style="margin-top:0">1) Infos chantier</h2>
                    <div class="row">
                        <div>
                            <label>Adresse (ville)</label>
                            <input id="ville" list="ville-list" placeholder="Montpellier, B√©ziers, S√®te‚Ä¶"/>
                            <datalist id="ville-list"></datalist>
                        </div>
                        <div>
                            <label>Date souhait√©e</label>
                            <input id="date" type="date"/>
                        </div>
                    </div>
                    
                    <div class="row3" style="margin-top:10px">
                        <div>
                            <label>√âtage</label>
                            <input id="etage" type="number" min="0" value="0"/>
                            <div class="muted">0 = RDC</div>
                        </div>
                        <div>
                            <label>Ascenseur</label>
                            <select id="ascenseur">
                                <option>Oui</option>
                                <option>Non</option>
                            </select>
                        </div>
                        <div>
                            <label>Portage depuis stationnement (m)</label>
                            <input id="portage" type="number" min="0" value="10"/>
                        </div>
                    </div>
                    
                    <div class="row3" style="margin-top:10px">
                        <div>
                            <label>Acc√®s global</label>
                            <select id="acces">
                                <option value="simple">Simple</option>
                                <option value="normal" selected>Normal</option>
                                <option value="difficile">Difficile</option>
                            </select>
                            <div class="muted">Largeur/hauteur, couloirs, contraintes‚Ä¶</div>
                        </div>
                        <div>
                            <label>Stationnement</label>
                            <select id="stationnement">
                                <option value="facile">Facile</option>
                                <option value="moyen">Moyen</option>
                                <option value="difficile">Difficile</option>
                            </select>
                        </div>
                        <div>
                            <label>Frais de stationnement (‚Ç¨)</label>
                            <input id="parking_fees" type="number" min="0" value="0"/>
                        </div>
                    </div>
                    
                    <div class="row3" style="margin-top:10px">
                        <div>
                            <label>Acc√®s engins (camion, mini‚Äëpelle, benne)</label>
                            <select id="engins">
                                <option value="ok">Possible</option>
                                <option value="limit√©">Limit√©</option>
                                <option value="impossible">Impossible</option>
                            </select>
                        </div>
                        <div>
                            <label>D√©chets √† √©vacuer (m¬≥)</label>
                            <input id="dechets" type="number" min="0" value="0"/>
                        </div>
                        <div>
                            <label>Complexit√© coordination</label>
                            <select id="complexite">
                                <option value="basse">Basse</option>
                                <option value="moyenne" selected>Moyenne</option>
                                <option value="haute">Haute</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="step-2" class="card" style="margin-top:12px">
                    <h2 style="margin-top:0">2) M√©tiers &amp; t√¢ches</h2>
                    <div class="grid-gap">
                        <div id="tasks"></div>
                        <div class="row">
                            <button id="add-task" class="btn btn-ghost" type="button">+ Ajouter une t√¢che</button>
                            <button id="add-manual-task" class="btn btn-ghost" type="button">+ T√¢che libre</button>
                        </div>
                        <div class="muted">S√©lectionnez un m√©tier puis une t√¢che, ou ajoutez une t√¢che libre, puis indiquez la quantit√©.</div>
                    </div>
                </div>
                
                <div id="step-3" class="card" style="margin-top:12px">
                    <h2 style="margin-top:0">3) Options &amp; TVA</h2>
                    <div class="row3">
                        <div>
                            <label>Urgence</label>
                            <select id="urgence">
                                <option value="non">Non</option>
                                <option value="oui">Oui (+10%)</option>
                            </select>
                        </div>
                        <div>
                            <label>Week‚Äëend</label>
                            <select id="weekend">
                                <option value="non">Non</option>
                                <option value="oui">Oui (+25%)</option>
                            </select>
                    </div>
                    <div>
                        <label>Travail de nuit</label>
                        <select id="nuit">
                            <option value="non">Non</option>
                            <option value="oui">Oui (+20%)</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top:10px">
                    <label>Dur√©e du chantier</label>
                    <select id="duration_mode">
                        <option value="auto" selected>Automatique</option>
                        <option value="manual">Param√©trable</option>
                    </select>
                    <div id="speed-container" style="margin-top:5px">
                        <select id="speed">
                            <option value="rapide">Rapide</option>
                            <option value="normal" selected>Normal</option>
                            <option value="lent">Lent</option>
                        </select>
                    </div>
                    <input type="number" id="manual_days" placeholder="jours" min="1" style="margin-top:5px;display:none"/>
                </div>

                <div class="row" style="margin-top:10px">
                    <div>
                        <label>Pack / Marge</label>
                        <select id="pack">
                                <option value="standard">Standard (x1.00)</option>
                                <option value="confort">Confort (x1.12)</option>
                                <option value="premium">Premium (x1.25)</option>
                            </select>
                        </div>
                        <div>
                            <label>TVA automatique</label>
                            <select id="tva_mode">
                                <option value="auto">Auto (5,5 / 10 / 20)</option>
                                <option value="5.5">Forcer 5,5%</option>
                                <option value="10">Forcer 10%</option>
                                <option value="20">Forcer 20%</option>
                            </select>
                            <div class="muted">Auto : 5,5% si uniquement t√¢ches √©ligibles, sinon 10% si logement > 2 ans, sinon 20%.</div>
                        </div>
                    </div>

                    <div style="margin-top:10px">
                        <label>Remise</label>
                        <select id="discount_mode">
                            <option value="auto" selected>Automatique</option>
                            <option value="manual">Param√©trable</option>
                        </select>
                        <input type="number" id="discount_value" placeholder="%" min="0" max="100" style="margin-top:5px;display:none"/>
                    </div>

                    <div style="margin-top:10px">
                        <label><input id="logement_2ans" type="checkbox" checked/> Logement achev√© depuis plus de 2 ans</label>
                    </div>
                </div>
                
                <div id="step-4" class="card" style="margin-top:12px">
                    <h2 style="margin-top:0">4) Coordonn√©es</h2>
                    <div class="row3">
                        <div>
                            <label>Nom</label>
                            <input id="name" placeholder="Nom Pr√©nom"/>
                        </div>
                        <div>
                            <label>Email</label>
                            <input id="email" type="email" placeholder="vous@email.fr"/>
                        </div>
                        <div>
                            <label>T√©l√©phone</label>
                            <input id="phone" type="tel" placeholder="06 12 34 56 78"/>
                        </div>
                    </div>
                    
                    <div style="margin-top:10px">
                        <label>Commentaire</label>
                        <textarea id="comment" rows="3" placeholder="Infos compl√©mentaires, photos (lien), contraintes sp√©cifiques‚Ä¶"></textarea>
                    </div>
                    
                    <div class="hr"></div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button id="btn-prev" class="btn btn-ghost" type="button">‚Üê Pr√©c√©dent</button>
                        <button id="btn-next" class="btn btn-primary" type="button">Voir le r√©capitulatif ‚Üí</button>
                    </div>
                </div>
                
                <div id="step-5" class="card" style="margin-top:12px;display:none">
                    <h2 style="margin-top:0">5) R√©capitulatif &amp; envoi</h2>
                    <div id="recap"></div>
                    <div class="hr"></div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                        <button id="btn-pdf" class="btn btn-ghost" type="button">T√©l√©charger le devis</button>
                        <button id="btn-invoice" class="btn btn-ghost" type="button">T√©l√©charger la facture</button>
                        <button id="btn-send" class="btn btn-primary" type="button">Envoyer &amp; √™tre rappel√©</button>
                        <button id="btn-edit" class="btn btn-ghost" type="button">‚Üê Modifier</button>
                        <button id="btn-archives" class="btn btn-ghost" type="button">Archives</button>
                    </div>
                    <p class="muted" style="margin-top:8px">En envoyant, vous acceptez d'√™tre recontact√©. Donn√©es stock√©es de fa√ßon s√©curis√©e. Droit de rectification et suppression sur demande.</p>
                </div>
            </div>

            <div id="archives" class="card" style="margin-top:12px;display:none">
                <h2 style="margin-top:0">Archives</h2>
                <ul id="archive-list"></ul>
                <button id="btn-close-archives" class="btn btn-ghost" type="button">Fermer</button>
            </div>

            <div id="realtime-estimation" class="card" aria-live="polite" aria-atomic="true">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                    <h2 style="margin:0">Estimation en temps r√©el</h2>
                    <span class="badge" id="count-tasks">0 t√¢che</span>
                </div>
                
                <div class="row" style="margin-top:8px">
                    <div>
                        <div class="muted">Total estimatif HT</div>
                        <div class="price" id="total-ht">‚Äî</div>
                    </div>
                    <div>
                        <div class="muted">Total estimatif TTC</div>
                        <div class="price" id="total-ttc">‚Äî</div>
                    </div>
                </div>

                <div class="muted" style="margin-top:8px">Dur√©e estim√©e : <span id="duration">‚Äî</span></div>

                <table style="margin-top:10px">
                    <thead>
                        <tr>
                            <th>D√©tail</th>
                            <th class="right">HT</th>
                        </tr>
                    </thead>
                    <tbody id="rows"></tbody>
                    <tfoot>
                        <tr>
                            <td class="total">Total HT</td>
                            <td class="right total" id="f-total-ht">‚Äî</td>
                        </tr>
                        <tr id="discount-row" style="display:none">
                            <td>Remise commerciale</td>
                            <td class="right" id="discount-amt"></td>
                        </tr>
                        <tr>
                            <td>TVA <span id="tva-rate">‚Äî</span></td>
                            <td class="right" id="tva-amt">‚Äî</td>
                        </tr>
                        <tr>
                            <td class="total">Total TTC</td>
                            <td class="right total" id="f-total-ttc">‚Äî</td>
                        </tr>
                    </tfoot>
                </table>

                <div id="messages" class="alert" style="display:none;margin-top:12px"></div>

                <div class="alert" style="margin-top:12px">
                    Estimation indicative. Visite technique et devis sign√© n√©cessaires pour valider prix, quantit√©s et d√©lais. TVA r√©duite sous conditions.
                </div>
                
                <div class="muted" style="margin-top:10px" id="company-legal"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
        const navAuth = document.getElementById('nav-auth');
        const userNav = JSON.parse(localStorage.getItem('user') || 'null');
        if (navAuth) {
            if (userNav) {
                navAuth.href = 'account.html';
                navAuth.textContent = 'Mon compte';
                navAuth.classList.add('cta');
            } else {
                navAuth.href = 'login.html';
                navAuth.textContent = 'Se connecter';
            }
        }

        // Informations entreprise
        const DEFAULT_COMPANY = {
            name: 'SARL BRUNO MIRA',
            address: '34980 Combaillaux',
            phone: '04 xx xx xx xx',
            email: 'contact@exemple.fr',
            siren: '000 000 000',
            siret: '123 456 789 00010',
            rcs: 'XXX',
            tva: 'FRXX',
            insurance: 'RC & d√©cennale n¬∞ XXXXX'
        };
        let company = { ...DEFAULT_COMPANY, ...JSON.parse(localStorage.getItem('company') || '{}') };

        // Configuration
        const CATALOG = {
            "Maison neuve": [
                { id: 'maison_surface', label: 'Maison neuve ‚Äî surface totale', unit: 'm¬≤', rate: 1500, min: 80000, hours: 1.5 },
                { id: 'maison_chambre', label: 'Chambre', unit: 'm¬≤', rate: 900, min: 4500, hours: 0.5 },
                { id: 'maison_cuisine', label: 'Cuisine', unit: 'm¬≤', rate: 1200, min: 6000, hours: 0.6 },
                { id: 'maison_sdb', label: 'Salle de bains', unit: 'm¬≤', rate: 1300, min: 6500, hours: 0.7 },
                { id: 'maison_salon', label: 'Salon / S√©jour', unit: 'm¬≤', rate: 1000, min: 7000, hours: 0.6 }
            ],
            "Ma√ßonnerie": [
                { id: 'dalle_beton', label: 'Dalle b√©ton', unit: 'm¬≤', rate: 95, min: 800, hours: 0.5, subtasks: ["Pr√©paration du sol", "Coffrage", "Coulage du b√©ton"] },
                { id: 'ouverture_porteur', label: 'Ouverture mur porteur (IPN inclus)', unit: 'forfait', rate: 2800, min: 2800, hours: 35 },
                { id: 'demolition_cloison', label: 'D√©molition cloison', unit: 'm¬≤', rate: 35, min: 300, hours: 0.15 },
                { id: 'mur_agglo', label: 'Mur agglos 20', unit: 'm¬≤', rate: 85, min: 600, hours: 0.6 },
                { id: 'chape_liquide', label: 'Chape liquide', unit: 'm¬≤', rate: 22, min: 400, hours: 0.1 },
                { id: 'seuil_beton', label: 'Seuil b√©ton', unit: 'ml', rate: 60, min: 240, hours: 0.4 },
                { id: 'fondations_semelles', label: 'Fondations semelles filantes', unit: 'ml', rate: 120, min: 600, hours: 0.8 },
                { id: 'muret_cloture', label: 'Muret de cl√¥ture', unit: 'ml', rate: 95, min: 500, hours: 0.6 },
                { id: 'ragreage_sol', label: 'Ragr√©age sol', unit: 'm¬≤', rate: 18, min: 250, hours: 0.1 },
                { id: 'escalier_beton', label: 'Escalier b√©ton', unit: 'u', rate: 2200, min: 2200, hours: 30 },
                { id: 'mur_pierre', label: 'Mur en pierres s√®ches', unit: 'm¬≤', rate: 150, min: 600, hours: 0.9 }
            ],
            "Plomberie": [
                { id: 'reseau_ecs', label: 'R√©seau eau chaude/froide', unit: 'ml', rate: 42, min: 350, hours: 0.3 },
                { id: 'sdb_pack', label: 'Salle de bains ‚Äî pack (hors meubles)', unit: 'm¬≤', rate: 280, min: 2500, hours: 0.8 },
                { id: 'wc_suspendu', label: 'WC suspendu ‚Äî pose', unit: 'forfait', rate: 420, min: 420, hours: 8 },
                { id: 'chauffe_eau_200', label: 'Chauffe‚Äëeau 200 L ‚Äî pose', unit: 'forfait', rate: 380, min: 380, hours: 6 },
                { id: 'evac_eu', label: '√âvacuation EU', unit: 'ml', rate: 30, min: 180, hours: 0.2 },
                { id: 'receveur_douche', label: 'Receveur de douche ‚Äî pose', unit: 'forfait', rate: 380, min: 380, hours: 7 },
                { id: 'chaudiere_gaz', label: 'Chaudi√®re gaz condensation ‚Äî pose', unit: 'forfait', rate: 2500, min: 2500, hours: 30, subtasks: ["Raccordement gaz", "Test d'√©tanch√©it√©", "Mise en service"] },
                { id: 'raccordement_evier', label: 'Raccordement √©vier cuisine', unit: 'forfait', rate: 180, min: 180, hours: 3 },
                { id: 'pose_lavabo', label: 'Lavabo ‚Äî pose', unit: 'forfait', rate: 250, min: 250, hours: 5 },
                { id: 'debouchage_canalisation', label: 'D√©bouchage canalisation', unit: 'forfait', rate: 180, min: 180, hours: 3 }
            ],
            "√âlectricit√©": [
                { id: 'renov_t2', label: 'R√©novation √©lectrique T2', unit: 'forfait', rate: 3200, min: 3200, hours: 40 },
                { id: 'prise', label: 'Ajout prise', unit: 'u', rate: 55, min: 165, hours: 1 },
                { id: 'spots', label: 'Spots encastr√©s', unit: 'u', rate: 65, min: 195, hours: 0.8 },
                { id: 'tableau', label: 'Remplacement tableau', unit: 'forfait', rate: 450, min: 450, hours: 8 },
                { id: 'point_lumineux', label: 'Point lumineux', unit: 'u', rate: 70, min: 140, hours: 0.5 },
                { id: 'vmc_simple', label: 'VMC simple flux', unit: 'forfait', rate: 850, min: 850, hours: 16 },
                { id: 'prise_exterieure', label: 'Prise ext√©rieure √©tanche', unit: 'u', rate: 80, min: 160, hours: 0.8 },
                { id: 'mise_terre', label: 'Mise √† la terre compl√®te', unit: 'forfait', rate: 650, min: 650, hours: 14 },
                { id: 'chauffage_electrique', label: 'Radiateur √©lectrique ‚Äî pose', unit: 'u', rate: 150, min: 150, hours: 3 },
                { id: 'domotique_centrale', label: 'Centrale domotique', unit: 'forfait', rate: 1200, min: 1200, hours: 25 }
            ],
            "Carrelage": [
                { id: 'sol_interieur', label: 'Carrelage sol int√©rieur', unit: 'm¬≤', rate: 55, min: 500, hours: 0.3 },
                { id: 'terrasse', label: 'Terrasse carrel√©e', unit: 'm¬≤', rate: 75, min: 800, hours: 0.4 },
                { id: 'credence', label: 'Cr√©dence cuisine', unit: 'm¬≤', rate: 85, min: 200, hours: 0.2 },
                { id: 'faience', label: 'Fa√Øence murale', unit: 'm¬≤', rate: 45, min: 300, hours: 0.25 },
                { id: 'plinthes_carrelage', label: 'Plinthes assorties', unit: 'ml', rate: 15, min: 120, hours: 0.05 },
                { id: 'escalier_carrelage', label: 'Escalier carrel√©', unit: 'u', rate: 110, min: 330, hours: 2 },
                { id: 'pose_mosaique', label: 'Pose mosa√Øque', unit: 'm¬≤', rate: 95, min: 200, hours: 0.3 },
                { id: 'carrelage_mural_sdb', label: 'Carrelage mural salle de bains', unit: 'm¬≤', rate: 65, min: 300, hours: 0.3 },
                { id: 'joint_carrelage', label: 'R√©alisation joints carrelage', unit: 'm¬≤', rate: 10, min: 100, hours: 0.1 }
            ],
            "Peinture": [
                { id: 'murs_plafonds', label: 'Peinture murs & plafonds', unit: 'm¬≤', rate: 14, min: 300, hours: 0.15 },
                { id: 'boiseries_laque', label: 'Boiseries ‚Äî laque', unit: 'm¬≤', rate: 22, min: 220, hours: 0.2 },
                { id: 'enduit_lissage', label: 'Enduit de lissage', unit: 'm¬≤', rate: 12, min: 180, hours: 0.15 },
                { id: 'peinture_facade', label: 'Peinture de fa√ßade', unit: 'm¬≤', rate: 28, min: 600, hours: 0.25 },
                { id: 'papier_peint', label: 'Pose papier peint', unit: 'm¬≤', rate: 20, min: 200, hours: 0.2 },
                { id: 'peinture_anti_humidite', label: 'Peinture anti-humidit√©', unit: 'm¬≤', rate: 18, min: 180, hours: 0.18 },
                { id: 'peinture_boiseries_ext', label: 'Boiseries ext√©rieures', unit: 'm¬≤', rate: 25, min: 250, hours: 0.25 },
                { id: 'peinture_radiateur', label: 'Peinture radiateur', unit: 'u', rate: 40, min: 80, hours: 0.5 }
            ],
            "Menuiserie": [
                { id: 'porte_interieure', label: 'Porte int√©rieure ‚Äî pose', unit: 'u', rate: 110, min: 220, hours: 3 },
                { id: 'fenetre_pvc', label: 'Fen√™tre PVC double vitrage', unit: 'u', rate: 450, min: 450, hours: 8 },
                { id: 'volet_roulant', label: 'Volet roulant motoris√©', unit: 'u', rate: 500, min: 500, hours: 5 },
                { id: 'parquet_flottant', label: 'Parquet flottant', unit: 'm¬≤', rate: 35, min: 300, hours: 0.25 },
                { id: 'placard_sur_mesure', label: 'Placard sur mesure', unit: 'ml', rate: 300, min: 600, hours: 6 },
                { id: 'escalier_bois', label: 'Escalier bois ‚Äî pose', unit: 'forfait', rate: 2800, min: 2800, hours: 45 },
                { id: 'fenetre_aluminium', label: 'Fen√™tre aluminium', unit: 'u', rate: 650, min: 650, hours: 10 }
            ],
            "Pl√¢trerie": [
                { id: 'cloison_ba13', label: 'Cloison BA13 sur ossature', unit: 'm¬≤', rate: 45, min: 350, hours: 0.3 },
                { id: 'doublage_isolant', label: 'Doublage isolant', unit: 'm¬≤', rate: 40, min: 320, hours: 0.25 },
                { id: 'plafond_suspendu', label: 'Plafond suspendu', unit: 'm¬≤', rate: 55, min: 400, hours: 0.4 },
                { id: 'corniche_staff', label: 'Corniche staff', unit: 'ml', rate: 25, min: 150, hours: 0.1 },
                { id: 'joint_placo', label: 'Joint placo', unit: 'ml', rate: 3, min: 100, hours: 0.02 },
                { id: 'cloison_acoustique', label: 'Cloison acoustique', unit: 'm¬≤', rate: 65, min: 500, hours: 0.5 },
                { id: 'reparation_fissures', label: 'R√©paration fissures', unit: 'ml', rate: 12, min: 120, hours: 0.1 }
            ],
            "Couverture": [
                { id: 'toiture_tuile', label: 'Toiture tuiles neuve', unit: 'm¬≤', rate: 85, min: 1500, hours: 0.6 },
                { id: 'reparation_fuite', label: 'R√©paration fuite toiture', unit: 'forfait', rate: 450, min: 450, hours: 6 },
                { id: 'pose_gouttiere', label: 'Pose goutti√®re zinc', unit: 'ml', rate: 35, min: 210, hours: 0.25 },
                { id: 'demoussage_toiture', label: 'D√©moussage toiture', unit: 'm¬≤', rate: 12, min: 300, hours: 0.1 },
                { id: 'reprise_faitiere', label: 'Reprise fa√Æti√®re', unit: 'ml', rate: 65, min: 325, hours: 0.4 },
                { id: 'pose_velux', label: 'Pose fen√™tre de toit', unit: 'u', rate: 850, min: 850, hours: 16 },
                { id: 'isolation_toiture', label: 'Isolation sous toiture', unit: 'm¬≤', rate: 40, min: 400, hours: 0.35 }
            ],
            "Isolation": [
                { id: 'isolation_combles', label: 'Isolation combles laine souffl√©e', unit: 'm¬≤', rate: 25, min: 500, hours: 0.2 },
                { id: 'isolation_murs', label: 'Isolation murs int√©rieurs', unit: 'm¬≤', rate: 35, min: 400, hours: 0.25 },
                { id: 'isolation_plancher', label: 'Isolation plancher bas', unit: 'm¬≤', rate: 30, min: 300, hours: 0.25 },
                { id: 'isolation_exterieure', label: 'Isolation ext√©rieure polystyr√®ne', unit: 'm¬≤', rate: 95, min: 1500, hours: 0.6 },
                { id: 'etancheite_air', label: "√âtanch√©it√© √† l'air ‚Äî membrane", unit: 'm¬≤', rate: 18, min: 200, hours: 0.1 },
                { id: 'isolation_phonique', label: 'Isolation phonique', unit: 'm¬≤', rate: 45, min: 450, hours: 0.3 },
                { id: 'depose_isolation', label: 'D√©pose ancienne isolation', unit: 'm¬≤', rate: 12, min: 240, hours: 0.15 }
            ],
            "Climatisation": [
                { id: 'clim_monosplit', label: 'Climatiseur monosplit ‚Äî pose', unit: 'forfait', rate: 1100, min: 1100, hours: 18 },
                { id: 'clim_multisplit_2ui', label: 'Climatiseur multisplit 2 unit√©s int√©rieures ‚Äî pose', unit: 'forfait', rate: 2200, min: 2200, hours: 40 },
                { id: 'clim_multisplit_3ui', label: 'Climatiseur multisplit 3 unit√©s int√©rieures ‚Äî pose', unit: 'forfait', rate: 3300, min: 3300, hours: 60 },
                { id: 'clim_multisplit_4ui', label: 'Climatiseur multisplit 4 unit√©s int√©rieures ‚Äî pose', unit: 'forfait', rate: 4400, min: 4400, hours: 80 },
                { id: 'clim_multisplit_5ui', label: 'Climatiseur multisplit 5 unit√©s int√©rieures ‚Äî pose', unit: 'forfait', rate: 5500, min: 5500, hours: 100 },
                { id: 'entretien_clim', label: 'Entretien climatisation', unit: 'forfait', rate: 120, min: 120, hours: 2 },
                { id: 'pompe_a_chaleur', label: 'Pompe √† chaleur air/eau', unit: 'forfait', rate: 8500, min: 8500, hours: 80 },
                { id: 'vmc_double_flux', label: 'VMC double flux', unit: 'forfait', rate: 3200, min: 3200, hours: 35 },
                { id: 'remplacement_filtre', label: 'Remplacement filtre', unit: 'forfait', rate: 90, min: 90, hours: 1.5 },
                { id: 'diagnostic_panne', label: 'Diagnostic panne climatisation', unit: 'forfait', rate: 150, min: 150, hours: 2 }
            ],
            "Terrassement": [
                { id: 'decaissement', label: 'D√©caissement terrain', unit: 'm¬≤', rate: 12, min: 400, hours: 0.2 },
                { id: 'tranchee_technique', label: 'Tranch√©e technique', unit: 'ml', rate: 30, min: 300, hours: 0.25 },
                { id: 'drainage_peripherique', label: 'Drainage p√©riph√©rique', unit: 'ml', rate: 40, min: 400, hours: 0.4 },
                { id: 'evacuation_deblais', label: '√âvacuation des d√©blais', unit: 'm¬≤', rate: 20, min: 300, hours: 0.3 },
                { id: 'couche_forme_tout_venant', label: 'R√©alisation de la couche de forme en tout-venant', unit: 'm¬≤', rate: 25, min: 400, hours: 0.3 },
                { id: 'remblaiement', label: 'Remblaiement', unit: 'm¬≤', rate: 8, min: 200, hours: 0.1 },
                { id: 'puits_perdu', label: 'Puits perdu', unit: 'u', rate: 450, min: 450, hours: 8 },
                { id: 'mur_soutenement', label: 'Mur de sout√®nement', unit: 'm¬≤', rate: 120, min: 800, hours: 1 }
            ],
            "Serrurerie": [
                { id: 'porte_blindee', label: 'Pose porte blind√©e', unit: 'forfait', rate: 1200, min: 1200, hours: 20 },
                { id: 'grille_securite', label: 'Grille de s√©curit√©', unit: 'm¬≤', rate: 220, min: 440, hours: 1.5 },
                { id: 'rideau_metal', label: 'Rideau m√©tallique motoris√©', unit: 'forfait', rate: 2500, min: 2500, hours: 35 },
                { id: 'serrure_3points', label: 'Serrure 3 points ‚Äî pose', unit: 'forfait', rate: 350, min: 350, hours: 4 },
                { id: 'depannage_serrurerie', label: 'D√©pannage ouverture porte', unit: 'forfait', rate: 120, min: 120, hours: 2 },
                { id: 'garde_corps', label: 'Garde-corps acier', unit: 'ml', rate: 180, min: 360, hours: 1.2 },
                { id: 'motorisation_portail', label: 'Motorisation portail', unit: 'forfait', rate: 950, min: 950, hours: 18 }
            ],
            "Am√©nagement ext√©rieur": [
                { id: 'pose_gazon', label: 'Pose gazon en rouleau', unit: 'm¬≤', rate: 15, min: 300, hours: 0.1 },
                { id: 'cloture_rigide', label: 'Cl√¥ture rigide', unit: 'ml', rate: 60, min: 300, hours: 0.5 },
                { id: 'allee_pavee', label: 'All√©e pav√©e', unit: 'm¬≤', rate: 75, min: 600, hours: 0.4 },
                { id: 'terrasse_bois', label: 'Terrasse bois', unit: 'm¬≤', rate: 110, min: 1000, hours: 0.7 },
                { id: 'abri_jardin', label: 'Abri de jardin ‚Äî montage', unit: 'forfait', rate: 650, min: 650, hours: 16 },
                { id: 'pergola_bois', label: 'Pergola bois', unit: 'forfait', rate: 2200, min: 2200, hours: 30 },
                { id: 'eclairage_jardin', label: '√âclairage de jardin', unit: 'forfait', rate: 650, min: 650, hours: 12 }
            ]
        };

        async function hydrateCatalogWithSubtasks() {
            const applySubtasks = (library, sourceLabel) => {
                if (!library) return false;
                const mapping = library.subtasks && typeof library.subtasks === 'object'
                    ? library.subtasks
                    : library;
                if (!mapping || typeof mapping !== 'object') {
                    return false;
                }
                let hydrated = false;
                Object.values(CATALOG).forEach(tasks => {
                    tasks.forEach(task => {
                        const subtasks = mapping[task.id];
                        if (Array.isArray(subtasks) && subtasks.length) {
                            task.subtasks = [...subtasks];
                            hydrated = true;
                        }
                    });
                });
                if (!hydrated && sourceLabel) {
                    console.warn(`Aucune sous-t√¢che correspondante trouv√©e dans ${sourceLabel}.`);
                }
                return hydrated;
            };

            let subtasksLoaded = false;

            try {
                const response = await fetch('subtasks.json', { cache: 'no-store' });
                if (response.ok) {
                    const data = await response.json();
                    subtasksLoaded = applySubtasks(data && (data.subtasks || data), 'subtasks.json');
                } else {
                    console.warn(`Impossible de charger les sous-t√¢ches (statut HTTP ${response.status}).`);
                }
            } catch (error) {
                console.warn('Impossible de charger les sous-t√¢ches √† partir du fichier JSON.', error);
            }

            if (!subtasksLoaded && window.SUBTASK_LIBRARY) {
                subtasksLoaded = applySubtasks(
                    window.SUBTASK_LIBRARY.subtasks || window.SUBTASK_LIBRARY,
                    'la biblioth√®que embarqu√©e'
                );
            }

            if (!subtasksLoaded) {
                console.warn("Aucune sous-t√¢che n'a pu √™tre charg√©e. V√©rifiez subtasks.json ou subtasks.js.");
            }
        }

        // T√¢ches √©ligibles √† la TVA r√©duite (5,5¬†%)
        const TVA55_TASKS = new Set([
            'chauffe_eau_200',
            'chaudiere_gaz',
            'isolation_combles',
            'isolation_murs',
            'isolation_plancher',
            'isolation_exterieure',
            'etancheite_air',
            'pompe_a_chaleur',
            'vmc_double_flux'
        ]);

        // Distances approximatives depuis Vailhauqu√®s (km aller simple)
        const CITY_DISTANCES = {
            montpellier: 15,
            beziers: 70,
            sete: 45,
            nimes: 85,
            agde: 75
        };
        const BASE_COORDS = { lat: 43.65, lon: 3.72 }; // Vailhauqu√®s approximatif
        const FUEL_COST_PER_KM = 0.5;
        const FLOOR_COST_NO_ELEVATOR = 15;
        const PORTAGE_COST_PER_M = 0.5;
        const WASTE_COST_PER_M3 = 50;
        async function getDistanceFromCity(city) {
            const normalizedCity = (city || '').trim();
            if (!normalizedCity) return 0;
            const key = normalizedCity.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            if (CITY_DISTANCES[key]) return CITY_DISTANCES[key];
            try {
                const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(normalizedCity)}&limit=1&autocomplete=0&lat=${BASE_COORDS.lat}&lon=${BASE_COORDS.lon}`);
                if (res.ok) {
                    const data = await res.json();
                    const feature = data.features && data.features[0];
                    if (feature) {
                        const [lon, lat] = feature.geometry.coordinates;
                        const R = 6371; // Rayon terrestre en km
                        const dLat = (lat - BASE_COORDS.lat) * Math.PI / 180;
                        const dLon = (lon - BASE_COORDS.lon) * Math.PI / 180;
                        const a = Math.sin(dLat / 2) ** 2 + Math.cos(BASE_COORDS.lat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        const dist = Math.round(R * c);
                        CITY_DISTANCES[key] = dist;
                        return dist;
                    }
                }
            } catch (e) {
                console.error('Erreur distance', e);
            }
            return 20;
        }

        // Variables globales
        let currentStep = 0;
        let pdfRows = [];
        // Helper functions
        // Formatting utility that avoids locale-specific non breaking spaces
        // to keep PDF output compatible with basic fonts.
        const formatEUR = n => {
            const value = (n || 0).toLocaleString('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })
                .replace(/[\u202F\u00A0]/g, ' ');
            return `${value} EUR`;
        };
        const byId = id => document.getElementById(id);

        function renderCompany() {
            byId('company-title').textContent = company.name;
            document.title = 'Devis intelligent ‚Äî ' + company.name;
            const legal = `${company.name} ‚Äî SIREN ${company.siren} ‚Äî RCS ${company.rcs} ‚Äî TVA ${company.tva} ‚Äî ${company.insurance} ‚Äî ${company.address} ‚Äî ${company.email} ‚Äî ${company.phone}. Validit√© 30 jours.`;
            byId('company-legal').textContent = legal;
            const logo = company.name.split(/\s+/).map(w => w[0]).join('').slice(0,2).toUpperCase();
            byId('company-logo').textContent = logo;
            byId('c-name').value = company.name;
            byId('c-address').value = company.address;
            byId('c-phone').value = company.phone;
            byId('c-email').value = company.email;
            byId('c-siren').value = company.siren;
            byId('c-siret').value = company.siret;
            byId('c-rcs').value = company.rcs;
            byId('c-tva').value = company.tva;
            byId('c-assurance').value = company.insurance;
        }

        function saveCompany() {
            company = {
                name: byId('c-name').value.trim(),
                address: byId('c-address').value.trim(),
                phone: byId('c-phone').value.trim(),
                email: byId('c-email').value.trim(),
                siren: byId('c-siren').value.trim(),
                siret: byId('c-siret').value.trim(),
                rcs: byId('c-rcs').value.trim(),
                tva: byId('c-tva').value.trim(),
                insurance: byId('c-assurance').value.trim()
            };
            localStorage.setItem('company', JSON.stringify(company));
            renderCompany();
        }

        // Fonction pour cr√©er une ligne de t√¢che
        function addTaskRow() {
            const tasksContainer = byId('tasks');
            const block = document.createElement('div');
            block.className = 'task-block';
            const row = document.createElement('div');
            row.className = 'task-row';

            // S√©lection du m√©tier
            const tradeSelect = document.createElement('select');
            tradeSelect.className = 'trade-select';
            tradeSelect.innerHTML = '<option value="">Choisir un m√©tier...</option>';
            Object.keys(CATALOG).forEach(trade => {
                const option = document.createElement('option');
                option.value = trade;
                option.textContent = trade;
                tradeSelect.appendChild(option);
            });

            // S√©lection de la t√¢che
            const taskSelect = document.createElement('select');
            taskSelect.className = 'task-select';
            taskSelect.innerHTML = '<option value="">Choisir une t√¢che...</option>';
            taskSelect.disabled = true;

            const subtaskContainer = document.createElement('div');
            subtaskContainer.className = 'subtasks';

            // Quantit√©
            const qtyInput = document.createElement('input');
            qtyInput.className = 'qty-input';
            qtyInput.type = 'number';
            qtyInput.min = '0';
            qtyInput.value = '1';
            qtyInput.placeholder = 'Qt√©';

            // Unit√©
            const unitDiv = document.createElement('div');
            unitDiv.className = 'pill';
            unitDiv.textContent = '‚Äî';

            const detailInput = document.createElement('input');
            detailInput.className = 'detail-input';
            detailInput.type = 'text';
            detailInput.placeholder = 'D√©tails';

            // Bouton supprimer
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-ghost';
            deleteBtn.type = 'button';
            deleteBtn.textContent = 'üóëÔ∏è';

            // Event listeners
            tradeSelect.addEventListener('change', function() {
                const selectedTrade = this.value;
                taskSelect.innerHTML = '<option value="">Choisir une t√¢che...</option>';
                subtaskContainer.innerHTML = '';

                if (selectedTrade && CATALOG[selectedTrade]) {
                    taskSelect.disabled = false;
                    CATALOG[selectedTrade].forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.id;
                        option.textContent = task.label;
                        option.dataset.unit = task.unit;
                        option.dataset.rate = task.rate;
                        option.dataset.min = task.min;
                        option.dataset.hours = task.hours;
                        option.dataset.tva55 = TVA55_TASKS.has(task.id) ? '1' : '0';
                        if (task.subtasks) option.dataset.subtasks = task.subtasks.join('|');
                        taskSelect.appendChild(option);
                    });
                } else {
                    taskSelect.disabled = true;
                }

                unitDiv.textContent = '‚Äî';
                qtyInput.disabled = false;
                qtyInput.value = '1';
                updatePricing();
            });

            taskSelect.addEventListener('change', function() {
                const selectedOption = this.selectedOptions[0];
                subtaskContainer.innerHTML = '';
                if (selectedOption && selectedOption.dataset.unit) {
                    unitDiv.textContent = selectedOption.dataset.unit;

                    // Si c'est un forfait, mettre la quantit√© √† 1 mais permettre la modification
                    if (selectedOption.dataset.unit === 'forfait') {
                        qtyInput.value = '1';
                    }
                    qtyInput.disabled = false;
                    if (selectedOption.dataset.subtasks) {
                        selectedOption.dataset.subtasks.split('|').forEach(st => addSubtask(subtaskContainer, st));
                    }
                } else {
                    unitDiv.textContent = '‚Äî';
                    qtyInput.disabled = false;
                }
                updatePricing();
            });

            qtyInput.addEventListener('input', updatePricing);
            detailInput.addEventListener('input', updatePricing);

            deleteBtn.addEventListener('click', function() {
                block.remove();
                updatePricing();
            });

            // Assembler la ligne
            row.appendChild(tradeSelect);
            row.appendChild(taskSelect);
            row.appendChild(qtyInput);
            row.appendChild(unitDiv);
            row.appendChild(detailInput);
            row.appendChild(deleteBtn);

            block.appendChild(row);
            const subtaskContainer = document.createElement('div');
            subtaskContainer.className = 'subtasks';
            block.appendChild(subtaskContainer);

            const addSubBtn = document.createElement('button');
            addSubBtn.className = 'btn btn-ghost';
            addSubBtn.type = 'button';
            addSubBtn.textContent = '+ Sous-t√¢che';
            addSubBtn.addEventListener('click', function() {
                addSubtask(subtaskContainer);
                updatePricing();
            });
            block.appendChild(addSubBtn);

            tasksContainer.appendChild(block);
            updatePricing();
        }

        function addManualTaskRow() {
            const tasksContainer = byId('tasks');
            const block = document.createElement('div');
            block.className = 'task-block';
            const row = document.createElement('div');
            row.className = 'task-row manual';

            const tradeInput = document.createElement('input');
            tradeInput.className = 'trade-input';
            tradeInput.type = 'text';
            tradeInput.placeholder = 'M√©tier';

            const labelInput = document.createElement('input');
            labelInput.className = 'label-input';
            labelInput.type = 'text';
            labelInput.placeholder = 'T√¢che';

            const qtyInput = document.createElement('input');
            qtyInput.className = 'qty-input';
            qtyInput.type = 'number';
            qtyInput.min = '0';
            qtyInput.value = '1';
            qtyInput.placeholder = 'Qt√©';

            const unitInput = document.createElement('input');
            unitInput.className = 'unit-input';
            unitInput.type = 'text';
            unitInput.placeholder = 'Unit√©';

            const rateInput = document.createElement('input');
            rateInput.className = 'rate-input';
            rateInput.type = 'number';
            rateInput.min = '0';
            rateInput.placeholder = 'PU HT';

            const detailInput = document.createElement('input');
            detailInput.className = 'detail-input';
            detailInput.type = 'text';
            detailInput.placeholder = 'D√©tails';

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-ghost';
            deleteBtn.type = 'button';
            deleteBtn.textContent = 'üóëÔ∏è';

            [tradeInput, labelInput, qtyInput, unitInput, rateInput, detailInput].forEach(el => {
                el.addEventListener('input', updatePricing);
            });
            deleteBtn.addEventListener('click', function() {
                block.remove();
                updatePricing();
            });

            row.appendChild(tradeInput);
            row.appendChild(labelInput);
            row.appendChild(qtyInput);
            row.appendChild(unitInput);
            row.appendChild(rateInput);
            row.appendChild(detailInput);
            row.appendChild(deleteBtn);

            block.appendChild(row);
            block.appendChild(subtaskContainer);

            const addSubBtn = document.createElement('button');
            addSubBtn.className = 'btn btn-ghost';
            addSubBtn.type = 'button';
            addSubBtn.textContent = '+ Sous-t√¢che';
            addSubBtn.addEventListener('click', function() {
                addSubtask(subtaskContainer);
                updatePricing();
            });
            block.appendChild(addSubBtn);

            tasksContainer.appendChild(block);
            updatePricing();
        }

        function addSubtask(container, value = '') {
            const row = document.createElement('div');
            row.className = 'subtask-row';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'subtask-input';
            input.placeholder = 'Sous-t√¢che';
            input.value = value;
            input.addEventListener('input', updatePricing);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-ghost';
            deleteBtn.type = 'button';
            deleteBtn.textContent = 'üóëÔ∏è';
            deleteBtn.addEventListener('click', function() {
                row.remove();
                updatePricing();
            });
            row.appendChild(input);
            row.appendChild(deleteBtn);
            container.appendChild(row);
        }

        // Fonction pour lire toutes les t√¢ches
        function readTasks() {
            const taskBlocks = document.querySelectorAll('.task-block');
            const result = [];

            taskBlocks.forEach(block => {
                const row = block.querySelector('.task-row');
                const subtasks = Array.from(block.querySelectorAll('.subtask-input'))
                    .map(i => i.value.trim())
                    .filter(Boolean);

                if (row.classList.contains('manual')) {
                    const trade = row.querySelector('.trade-input').value.trim();
                    const label = row.querySelector('.label-input').value.trim();
                    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                    const unit = row.querySelector('.unit-input').value.trim();
                    const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
                    const detail = row.querySelector('.detail-input').value.trim();
                    if (trade && label && qty > 0 && rate > 0 && unit) {
                        result.push({
                            trade: trade,
                            taskId: 'custom',
                            label: label,
                            unit: unit,
                            rate: rate,
                            min: 0,
                            hours: 0,
                            qty: qty,
                            tva55: false,
                            detail: detail,
                            subtasks: subtasks
                        });
                    }
                } else {
                    const tradeSelect = row.querySelector('.trade-select');
                    const taskSelect = row.querySelector('.task-select');
                    const qtyInput = row.querySelector('.qty-input');
                    const detail = row.querySelector('.detail-input').value.trim();

                    const trade = tradeSelect.value;
                    const taskId = taskSelect.value;
                    const qty = parseFloat(qtyInput.value) || 0;

                    if (trade && taskId && qty > 0) {
                        const taskOption = taskSelect.selectedOptions[0];
                        if (taskOption) {
                            result.push({
                                trade: trade,
                                taskId: taskId,
                                label: taskOption.textContent,
                                unit: taskOption.dataset.unit,
                                rate: parseFloat(taskOption.dataset.rate),
                                min: parseFloat(taskOption.dataset.min),
                                hours: parseFloat(taskOption.dataset.hours),
                                qty: qty,
                                tva55: taskOption.dataset.tva55 === '1',
                                detail: detail,
                                subtasks: subtasks
                            });
                        }
                    }
                }
            });

            return result;
        }

        // Fonction de calcul des prix
        async function updatePricing() {
            const tasks = readTasks();
            let tasksTotal = 0;
            let totalHours = 0;
            const rows = [];
            const tradeTotals = {};
            const messages = [];

            // Taux de majoration appliqu√© aux t√¢ches en fonction des options
            let optionRate = 0;
            if (byId('urgence').value === 'oui') optionRate += 0.10;
            if (byId('weekend').value === 'oui') optionRate += 0.25;
            if (byId('nuit').value === 'oui') optionRate += 0.20;
            const pack = byId('pack').value;
            if (pack === 'confort') optionRate += 0.12;
            else if (pack === 'premium') optionRate += 0.25;

            // Calcul du prix des t√¢ches avec majoration √©ventuelle
            tasks.forEach(task => {
                let price = 0;

                switch (task.unit) {
                    case 'm¬≤':
                    case 'ml':
                    case 'u':
                        price = task.rate * task.qty;
                        break;
                    case 'forfait':
                        price = task.rate * task.qty;
                        break;
                }

                // Appliquer le minimum
                if (task.min) {
                    price = Math.max(price, task.min);
                }

                // Marge automatique
                const marginRate = task.hours > 0 ? 0.30 : 0.15;
                price *= (1 + marginRate);

                // R√©partir les options sur les t√¢ches
                price *= (1 + optionRate);

                const hours = task.hours * task.qty;
                totalHours += hours;
                tasksTotal += price;
                let description = `${task.trade} ‚Äî ${task.label}`;
                if (task.detail) {
                    description += ` ‚Äî ${task.detail}`;
                }
                if (task.subtasks && task.subtasks.length > 0) {
                    description += '\n' + task.subtasks.map(st => `- ${st}`).join('\n');
                }
                rows.push({ trade: task.trade, description, qty: task.qty, unit: task.unit, price });
            });

            const baseTotal = tasksTotal;
            let siteRate = 0;
            let siteFixed = 0;
            const floor = parseInt(byId('etage').value) || 0;
            if (byId('ascenseur').value === 'Non') siteFixed += floor * FLOOR_COST_NO_ELEVATOR;
            siteFixed += (parseFloat(byId('portage').value) || 0) * PORTAGE_COST_PER_M;
            switch (byId('acces').value) {
                case 'difficile': siteRate += 0.05; break;
            }
            switch (byId('stationnement').value) {
                case 'moyen': siteRate += 0.02; break;
                case 'difficile': siteRate += 0.05; break;
            }
            siteFixed += parseFloat(byId('parking_fees').value) || 0;
            switch (byId('engins').value) {
                case 'limit√©':
                    siteRate += 0.03;
                    messages.push('Attention, acc√®s engins limit√© : +3 %');
                    break;
                case 'impossible':
                    siteRate += 0.07;
                    messages.push('Attention, engins non accessibles : +7 %');
                    break;
            }
            siteFixed += (parseFloat(byId('dechets').value) || 0) * WASTE_COST_PER_M3;
            switch (byId('complexite').value) {
                case 'moyenne': siteRate += 0.05; break;
                case 'haute': siteRate += 0.10; break;
            }
            const siteExtra = siteFixed + baseTotal * siteRate;
            if (siteExtra > 0 && baseTotal > 0) {
                rows.forEach(row => {
                    const share = (row.price / baseTotal) * siteExtra;
                    row.price += share;
                });
                tasksTotal += siteExtra;
            }

            // Dur√©e estim√©e du chantier
            let workDays, days;
            const durationMode = byId('duration_mode') ? byId('duration_mode').value : 'auto';
            if (durationMode === 'manual') {
                days = parseFloat(byId('manual_days').value) || 0;
                workDays = days;
            } else {
                workDays = totalHours / 7;
                const speed = byId('speed') ? byId('speed').value : 'normal';
                const speedFactor = speed === 'rapide' ? 0.8 : speed === 'lent' ? 1.2 : 1;
                workDays *= speedFactor;
                days = totalHours > 0 ? Math.ceil(workDays) : 0;
            }

            // Co√ªt des trajets bas√© sur la dur√©e r√©elle
            const distance = await getDistanceFromCity(byId('ville').value);
            const travelCost = distance * 2 * workDays * FUEL_COST_PER_KM;
            if (travelCost > 0 && tasksTotal > 0) {
                rows.forEach(row => {
                    const share = (row.price / tasksTotal) * travelCost;
                    row.price += share;
                });
                tasksTotal += travelCost;
            }

            rows.forEach(r => {
                tradeTotals[r.trade] = (tradeTotals[r.trade] || 0) + r.price;
            });

            let totalHT = tasksTotal;

            // Remise commerciale
            const discountMode = byId('discount_mode') ? byId('discount_mode').value : 'auto';
            let remiseAmount = 0;
            if (discountMode === 'manual') {
                const rate = parseFloat(byId('discount_value').value) || 0;
                remiseAmount = totalHT * rate / 100;
            } else {
                const remiseThreshold = 10000;
                const remiseRate = totalHT > remiseThreshold ? 0.05 : 0;
                if (remiseRate > 0) {
                    remiseAmount = totalHT * remiseRate;
                }
            }
            if (remiseAmount > 0) {
                totalHT -= remiseAmount;
                byId('discount-row').style.display = '';
                byId('discount-amt').textContent = '-' + formatEUR(remiseAmount);
            } else {
                byId('discount-row').style.display = 'none';
            }

            // TVA
            const tvaMode = byId('tva_mode').value;
            const logement2ans = byId('logement_2ans').checked;
            let tvaRate;

            if (tvaMode === 'auto') {
                const all55 = tasks.length > 0 && tasks.every(t => t.tva55);
                if (all55) {
                    tvaRate = 0.055;
                } else if (logement2ans) {
                    tvaRate = 0.10;
                } else {
                    tvaRate = 0.20;
                }
            } else {
                tvaRate = parseFloat(tvaMode) / 100;
            }

            const tvaAmount = totalHT * tvaRate;
            const totalTTC = totalHT + tvaAmount;

            pdfRows = rows.map(r => ({
                description: r.description,
                qty: r.qty,
                unitPrice: r.price / (r.qty || 1),
                total: r.price
            }));
            Object.entries(tradeTotals).forEach(([trade, sum]) => {
                pdfRows.push({ description: `Sous-total ${trade}`, qty: '', unitPrice: '', total: sum });
            });

            // Mise √† jour de l'affichage
            byId('total-ht').textContent = formatEUR(totalHT);
            byId('total-ttc').textContent = formatEUR(totalTTC);
            byId('f-total-ht').textContent = formatEUR(totalHT);
            byId('f-total-ttc').textContent = formatEUR(totalTTC);
            byId('tva-rate').textContent = `${(tvaRate * 100).toFixed(1).replace(/\.0$/, '')}%`;
            byId('tva-amt').textContent = formatEUR(tvaAmount);
            byId('count-tasks').textContent = `${tasks.length} ${tasks.length > 1 ? 't√¢ches' : 't√¢che'}`;
            byId('duration').textContent = days > 0 ? `${days} ${days > 1 ? 'jours' : 'jour'}` : '‚Äî';

            // Mise √† jour du tableau d√©taill√©
            const rowsContainer = byId('rows');
            rowsContainer.innerHTML = '';

            rows.forEach(row => {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td');
                td1.textContent = `${row.description} (${row.qty} ${row.unit})`;
                const td2 = document.createElement('td');
                td2.className = 'right';
                td2.textContent = formatEUR(row.price);
                tr.appendChild(td1);
                tr.appendChild(td2);
                rowsContainer.appendChild(tr);
            });
            Object.entries(tradeTotals).forEach(([trade, sum]) => {
                const tr = document.createElement('tr');
                tr.className = 'subtotal';
                const td1 = document.createElement('td');
                td1.className = 'total';
                td1.textContent = `Sous-total ${trade}`;
                const td2 = document.createElement('td');
                td2.className = 'right total';
                td2.textContent = formatEUR(sum);
                tr.appendChild(td1);
                tr.appendChild(td2);
                rowsContainer.appendChild(tr);
            });

            const msgEl = byId('messages');
            if (msgEl) {
                if (messages.length) {
                    msgEl.innerHTML = messages.join('<br>');
                    msgEl.style.display = '';
                } else {
                    msgEl.style.display = 'none';
                }
            }
        }

        function initializeInteractions() {
            byId('add-task').addEventListener('click', addTaskRow);
            byId('add-manual-task').addEventListener('click', addManualTaskRow);
            const optionIds = ['urgence', 'weekend', 'nuit', 'speed', 'pack', 'tva_mode', 'discount_mode', 'duration_mode'];
            optionIds.forEach(id => {
                const el = byId(id);
                if (el) el.addEventListener('change', updatePricing);
            });
            const inputIds = ['discount_value', 'manual_days'];
            inputIds.forEach(id => {
                const el = byId(id);
                if (el) el.addEventListener('input', updatePricing);
            });

            function toggleDiscountInput() {
                const mode = byId('discount_mode').value;
                byId('discount_value').style.display = mode === 'manual' ? '' : 'none';
                if (mode !== 'manual') byId('discount_value').value = '';
            }
            function toggleDurationInput() {
                const mode = byId('duration_mode').value;
                byId('speed-container').style.display = mode === 'manual' ? 'none' : '';
                byId('manual_days').style.display = mode === 'manual' ? '' : 'none';
                if (mode !== 'manual') byId('manual_days').value = '';
            }
            const discountModeEl = byId('discount_mode');
            if (discountModeEl) discountModeEl.addEventListener('change', toggleDiscountInput);
            const durationModeEl = byId('duration_mode');
            if (durationModeEl) durationModeEl.addEventListener('change', toggleDurationInput);
            toggleDiscountInput();
            toggleDurationInput();
            const siteIds = ['etage', 'ascenseur', 'portage', 'acces', 'stationnement', 'parking_fees', 'engins', 'dechets', 'complexite'];
            siteIds.forEach(id => {
                const el = byId(id);
                if (el) {
                    el.addEventListener('change', updatePricing);
                    el.addEventListener('input', updatePricing);
                }
            });
            const logement2ansEl = byId('logement_2ans');
            if (logement2ansEl) logement2ansEl.addEventListener('change', updatePricing);
            const villeEl = byId('ville');
            if (villeEl) villeEl.addEventListener('input', updatePricing);
            addTaskRow();

        }

        // G√©n√©ration du r√©capitulatif
        function buildRecap() {
            const recap = byId('recap');
            const tasks = readTasks();
            let html = '<h3>Coordonn√©es</h3>';
            html += `<p>${byId('name').value} ‚Äî ${byId('email').value} ‚Äî ${byId('phone').value}</p>`;
            const comment = byId('comment').value.trim();
            if (comment) {
                html += `<p>${comment}</p>`;
            }
            if (tasks.length > 0) {
                html += '<h3>T√¢ches</h3><ul>';
                tasks.forEach(t => {
                    html += `<li>${t.trade} ‚Äî ${t.label} (${t.qty} ${t.unit})${t.detail ? ': ' + t.detail : ''}`;
                    if (t.subtasks && t.subtasks.length > 0) {
                        html += '<ul>';
                        t.subtasks.forEach(st => {
                            html += `<li>${st}</li>`;
                        });
                        html += '</ul>';
                    }
                    html += '</li>';
                });
                html += '</ul>';
            }
            html += `<p><strong>Total HT :</strong> ${byId('f-total-ht').textContent}<br><strong>Total TTC :</strong> ${byId('f-total-ttc').textContent} (TVA ${byId('tva-rate').textContent})</p>`;
            recap.innerHTML = html;
        }

        // Navigation vers le r√©capitulatif
        const btnNext = byId('btn-next');
        if (btnNext) {
            btnNext.addEventListener('click', async function () {
                await updatePricing();
                buildRecap();
                const step5 = byId('step-5');
                step5.style.display = 'block';
                step5.scrollIntoView({ behavior: 'smooth' });
            });
        }
        const btnEdit = byId('btn-edit');
        if (btnEdit) {
            btnEdit.addEventListener('click', function () {
                byId('step-5').style.display = 'none';
                byId('step-4').scrollIntoView({ behavior: 'smooth' });
            });
        }

        async function generatePdf(kind) {
            await updatePricing();
            buildRecap();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text(byId('company-logo').textContent || 'LOGO', 14, 20);
            if (kind === 'devis') {
                doc.setFontSize(12);
                doc.setTextColor(220, 38, 38);
                doc.text('DEVIS PROVISOIRE', 150, 20);
                doc.setTextColor(0, 0, 0);
            }
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            const title = kind === 'facture' ? 'FACTURE' : 'DEVIS';
            doc.text(title, 105, 30, { align: 'center' });

            let y = 40;
            doc.setFontSize(12);
            doc.text('Informations Entreprise', 14, y);
            y += 6;
            doc.setFont('helvetica', 'normal');
            doc.text(`Entreprise : ${company.name}`, 14, y); y += 6;
            doc.text(`Adresse : ${company.address}`, 14, y); y += 6;
            doc.text(`T√©l√©phone : ${company.phone}`, 14, y); y += 6;
            doc.text(`Email : ${company.email}`, 14, y); y += 6;
            doc.text(`SIREN : ${company.siren}`, 14, y); y += 6;
            doc.text(`SIRET : ${company.siret}`, 14, y); y += 6;
            doc.text(`RCS : ${company.rcs}`, 14, y); y += 6;
            doc.text(`TVA : ${company.tva}`, 14, y); y += 6;
            doc.text(`Assurance d√©cennale : ${company.insurance}`, 14, y); y += 10;

            doc.setFont('helvetica', 'bold');
            doc.text('Informations Client', 14, y);
            y += 6;
            doc.setFont('helvetica', 'normal');
            doc.text(`Nom : ${byId('name').value}`, 14, y); y += 6;
            doc.text(`Adresse : ${byId('ville').value}`, 14, y); y += 6;
            doc.text(`T√©l√©phone : ${byId('phone').value}`, 14, y); y += 10;

            const label = kind === 'facture' ? 'Facture' : 'Devis';
            doc.setFont('helvetica', 'bold');
            doc.text(`D√©tails ${kind === 'facture' ? 'de la' : 'du'} ${label}`, 14, y);
            y += 6;

            if (pdfRows.length > 0 && doc.autoTable) {
                doc.autoTable({
                    startY: y,
                    head: [['Description', 'Quantit√©', 'PU HT (EUR)', 'Total HT (EUR)']],
                    body: pdfRows.map(r => [r.description, r.qty.toString(), formatEUR(r.unitPrice), formatEUR(r.total)]),
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [0, 0, 0], textColor: 255 },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    theme: 'striped'
                });
                y = doc.lastAutoTable.finalY + 10;
            }

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Sous-total HT : ${byId('f-total-ht').textContent}`, 196, y, { align: 'right' });
            doc.text(`TVA (${byId('tva-rate').textContent}) : ${byId('tva-amt').textContent}`, 196, y + 7, { align: 'right' });
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(220, 38, 38);
            doc.text(`Total TTC : ${byId('f-total-ttc').textContent}`, 196, y + 14, { align: 'right' });
            doc.setTextColor(0, 0, 0);
            y += 26;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);

            const addTextBlock = text => {
                const lines = doc.splitTextToSize(text, 182);
                doc.text(lines, 14, y);
                y += lines.length * 5;
            };

            if (kind === 'devis') {
                addTextBlock('Dur√©e de validit√© du devis : 30 jours');
            }
            addTextBlock("Prix indiqu√© : sous r√©serve d'√©volution du co√ªt des mat√©riaux, ajust√© √† la commande, selon stock et la livraison.");
            addTextBlock(`TVA applicable : ${byId('tva-rate').textContent}`);
            addTextBlock("Mention l√©gale : 50% d'acompte √† la commande, solde √† la livraison.");
            addTextBlock('SRT l√©gales : TVA applicable, RC Pro, coordonn√©es disponibles sur demande.');

            addTextBlock('Signature :');
            doc.line(40, y, 120, y);
            y += 10;

            const dataUrl = doc.output('dataurlstring');
            saveArchive(kind, dataUrl);
            doc.save(`${kind}.pdf`);
        }

        function saveArchive(kind, dataUrl) {
            const archives = JSON.parse(localStorage.getItem('archives') || '[]');
            archives.push({ kind, dataUrl, date: new Date().toISOString() });
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.plan === 'starter') {
                const cutoff = new Date();
                cutoff.setMonth(cutoff.getMonth() - 12);
                const filtered = archives.filter(a => new Date(a.date) >= cutoff);
                localStorage.setItem('archives', JSON.stringify(filtered));
            } else {
                localStorage.setItem('archives', JSON.stringify(archives));
            }
        }

        function renderArchives() {
            const list = byId('archive-list');
            list.innerHTML = '';
            const archives = JSON.parse(localStorage.getItem('archives') || '[]');
            archives.forEach((a, i) => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = a.dataUrl;
                link.download = `${a.kind}-${i + 1}.pdf`;
                link.textContent = `${a.kind.toUpperCase()} - ${new Date(a.date).toLocaleString()}`;
                li.appendChild(link);
                list.appendChild(li);
            });
        }

        const btnPdf = byId('btn-pdf');
        if (btnPdf) {
            btnPdf.addEventListener('click', () => generatePdf('devis'));
        }

        const btnInvoice = byId('btn-invoice');
        if (btnInvoice) {
            btnInvoice.addEventListener('click', () => generatePdf('facture'));
        }

        const btnSend = byId('btn-send');
        if (btnSend) {
            btnSend.addEventListener('click', async function () {
                await updatePricing();
                buildRecap();
                const recapText = byId('recap').innerText;
                const subject = encodeURIComponent('Demande de devis');
                const body = encodeURIComponent(
                    `Bonjour,\n\nVoici ma demande de devis :\n\n${recapText}\n\nMerci de me rappeler au ${byId('phone').value}.`
                );
                window.location.href = `mailto:${company.email}?subject=${subject}&body=${body}`;
            });
        }

        const btnArchives = byId('btn-archives');
        if (btnArchives) {
            btnArchives.addEventListener('click', function () {
                const arch = byId('archives');
                if (arch.style.display === 'none') {
                    renderArchives();
                    arch.style.display = 'block';
                    arch.scrollIntoView({ behavior: 'smooth' });
                } else {
                    arch.style.display = 'none';
                }
            });
        }

        const btnCloseArchives = byId('btn-close-archives');
        if (btnCloseArchives) {
            btnCloseArchives.addEventListener('click', function () {
                const arch = byId('archives');
                arch.style.display = 'none';
                const list = byId('archive-list');
                if (list) list.innerHTML = '';
                const rt = byId('realtime-estimation');
                if (rt) rt.scrollIntoView({ behavior: 'smooth' });
            });
        }

        const btnCompany = byId('btn-company');
        if (btnCompany) {
            btnCompany.addEventListener('click', function () {
                const cs = byId('company-settings');
                cs.style.display = cs.style.display === 'none' ? 'block' : 'none';
            });
        }
        const btnSaveCompany = byId('btn-save-company');
        if (btnSaveCompany) {
            btnSaveCompany.addEventListener('click', function () {
                saveCompany();
                byId('company-settings').style.display = 'none';
            });
        }

        const themeToggle = byId('theme-toggle');
        if (themeToggle) {
            const applyTheme = t => {
                document.documentElement.setAttribute('data-theme', t);
                themeToggle.textContent = t === 'dark' ? 'Mode clair' : 'Mode sombre';
            };
            applyTheme(localStorage.getItem('theme') || 'dark');
            themeToggle.addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', current);
                applyTheme(current);
            });
        }

        const villeInput = byId('ville');
        const villeList = byId('ville-list');
        if (villeInput) {
            let debounce;
            villeInput.addEventListener('input', function () {
                const q = this.value.trim();
                if (debounce) clearTimeout(debounce);
                if (q.length < 3) return;
                debounce = setTimeout(async () => {
                    try {
                        const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&type=municipality&limit=5`);
                        const data = await res.json();
                        villeList.innerHTML = data.features.map(f => `<option value="${f.properties.label}"></option>`).join('');
                    } catch (e) { }
                }, 300);
            });
        }

        const stepsEls = [1,2,3,4,5].map(n => byId(`step-${n}`));
        const progressBarEl = byId('progress-bar');
        function updateProgressBar() {
            let current = 1;
            stepsEls.forEach((el, i) => {
                if (el.getBoundingClientRect().top <= 80) current = i + 1;
            });
            progressBarEl.style.width = (current / stepsEls.length) * 100 + '%';
        }
        document.addEventListener('scroll', updateProgressBar);
        updateProgressBar();

        async function initApp() {
            await hydrateCatalogWithSubtasks();
            initializeInteractions();
            renderCompany();
        }

        initApp();
        });
    </script>
</body>
</html>
