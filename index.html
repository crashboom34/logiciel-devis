diff --git a/README.md b/README.md
index 6aad243e3021326a8f84ad80d8968d29228e8302..fd0ada8c4e85bc3093044421cd8e65831056617f 100644
--- a/README.md
+++ b/README.md
@@ -1 +1,7 @@
-# logiciel-devis
\ No newline at end of file
+# logiciel-devis
+
+## Features
+- Multi-step form with progress bar and light/dark theme toggle
+- City auto-completion powered by api-adresse.data.gouv.fr
+- Automatic 5% discount for estimates above €10,000
+- PDF export with logo placeholder, provisional stamp and signature line
diff --git a/index.html b/index.html
index 3819c2b91bfd8b25d873a597e4178196c2129ae2..7ed1d78e251adecf46bfd35f498567bbcfb08071 100644
--- a/index.html
+++ b/index.html
@@ -1,118 +1,147 @@
 <!doctype html>
 <html lang="fr">
 <head>
     <meta charset="utf-8"/>
     <meta name="viewport" content="width=device-width,initial-scale=1"/>
     <title>Devis intelligent</title>
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
     <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
     <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
     <style>
-        :root {
-            --bg: #0b1220;
-            --fg: #e5e7eb;
-            --muted: #94a3b8;
-            --card: #0f172a;
-            --line: #1f2937;
-            --accent: #22c55e;
-            --danger: #ef4444;
-        }
+        :root {
+            --bg: #0b1220;
+            --bg-grad: #1a2333;
+            --fg: #f1f5f9;
+            --muted: #9ca3af;
+            --card: #0f172a;
+            --line: #1f2937;
+            --accent: #22c55e;
+            --danger: #ef4444;
+        }
+
+        html[data-theme='light'] {
+            --bg: #f9fafb;
+            --bg-grad: #f3f4f6;
+            --fg: #111827;
+            --muted: #374151;
+            --card: #ffffff;
+            --line: #d1d5db;
+            --accent: #16a34a;
+            --danger: #dc2626;
+        }
         
         * {
             box-sizing: border-box;
         }
         
         html, body {
             height: 100%;
         }
         
         body {
             margin: 0;
             font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
-            background: radial-gradient(circle at 25% 25%, #1e293b, var(--bg));
+            background: radial-gradient(circle at 25% 25%, var(--bg-grad), var(--bg));
             color: var(--fg);
             line-height: 1.6;
         }
         
-        a {
-            color: var(--accent);
-        }
+        a {
+            color: var(--accent);
+        }
+
+        #progress-container {
+            position: fixed;
+            top: 0;
+            left: 0;
+            width: 100%;
+            height: 4px;
+            background: var(--line);
+            z-index: 1000;
+        }
+
+        #progress-bar {
+            height: 100%;
+            width: 0;
+            background: var(--accent);
+            transition: width 0.3s ease;
+        }
         
         .container {
             max-width: 1200px;
             margin: 24px auto;
             padding: 0 16px;
         }
         
         header {
             display: flex;
             align-items: center;
             gap: 14px;
             margin-bottom: 14px;
         }
         
         .logo {
             width: 44px;
             height: 44px;
             border-radius: 12px;
             display: grid;
             place-items: center;
             background: linear-gradient(135deg, #16a34a, #22c55e);
             font-weight: 800;
             color: #001b0a;
         }
         
         h1 {
             font-size: 22px;
             margin: 0;
         }
         
         .sub {
             color: var(--muted);
             font-size: 13px;
             margin-top: 2px;
         }
         
         .layout {
             display: grid;
             grid-template-columns: 1.2fr 0.8fr;
             gap: 16px;
         }
         
         @media (max-width: 980px) {
             .layout {
                 grid-template-columns: 1fr;
             }
         }
         
         .card {
-            background: rgba(15, 23, 42, 0.75);
+            background: var(--card);
             backdrop-filter: blur(8px);
-            border: 1px solid rgba(255, 255, 255, 0.05);
+            border: 1px solid var(--line);
             border-radius: 16px;
             padding: 16px;
             box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
             transition: transform 0.3s ease, box-shadow 0.3s ease;
         }
 
         .card:hover {
             transform: translateY(-2px);
             box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
         }
         
         .stepper {
             display: flex;
             gap: 8px;
             flex-wrap: wrap;
             margin-bottom: 12px;
         }
         
         .step {
             padding: 8px 10px;
             border: 1px solid var(--line);
             border-radius: 12px;
             font-size: 13px;
             color: var(--muted);
             cursor: pointer;
@@ -138,61 +167,61 @@
         
         .row3 {
             display: grid;
             grid-template-columns: 1fr 1fr 1fr;
             gap: 12px;
         }
         
         @media (max-width: 720px) {
             .row, .row3 {
                 grid-template-columns: 1fr;
             }
         }
         
         label {
             font-weight: 600;
             font-size: 13px;
             margin-bottom: 6px;
             display: block;
         }
         
         input, select, button, textarea {
             width: 100%;
             padding: 12px;
             border-radius: 12px;
             border: 1px solid var(--line);
-            background: #0b1220;
+            background: var(--card);
             color: var(--fg);
             font-size: 14px;
             transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
         }
 
         input:focus, select:focus, textarea:focus {
             outline: none;
             border-color: var(--accent);
             box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
-            background: #111827;
+            background: var(--bg);
         }
         
         input[type="checkbox"], input[type="radio"] {
             width: auto;
         }
         
         .btn {
             cursor: pointer;
             font-weight: 800;
             letter-spacing: 0.2px;
             transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
             border-radius: 8px;
             padding: 8px 14px;
         }
         
         .btn-primary {
             background: linear-gradient(135deg, #16a34a, #22c55e);
             color: #001b0a;
             border: 0;
             box-shadow: 0 2px 6px rgba(34, 197, 94, 0.4);
         }
 
         .btn-primary:hover {
             box-shadow: 0 4px 12px rgba(34, 197, 94, 0.6);
             transform: translateY(-1px);
@@ -313,91 +342,95 @@
         }
 
         #recap {
             line-height: 1.6;
             font-size: 15px;
         }
 
         #recap h3 {
             margin-top: 20px;
             font-size: 16px;
             border-bottom: 1px solid var(--line);
             padding-bottom: 4px;
         }
 
         #recap ul {
             margin: 6px 0 12px 16px;
             padding: 0;
         }
 
         #recap li {
             margin-bottom: 4px;
         }
     </style>
 </head>
 <body>
-    <div class="container">
+    <div id="progress-container"><div id="progress-bar"></div></div>
+    <div class="container">
         <header>
             <div class="logo" id="company-logo">BM</div>
             <div>
                 <h1>Devis intelligent — <span id="company-title">SARL BRUNO MIRA</span></h1>
-                <div class="sub">Formulaire multi‑étapes · Tarification automatique par accès chantier, métiers et tâches · PDF & capture de lead</div>
-                <button id="btn-company" class="btn btn-ghost" type="button" style="margin-top:8px">Infos entreprise</button>
+                <div class="sub">Formulaire multi‑étapes · Tarification automatique par accès chantier, métiers et tâches · PDF &amp; capture de lead</div>
+                <div class="actions" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
+                    <button id="btn-company" class="btn btn-ghost" type="button">Infos entreprise</button>
+                    <button id="theme-toggle" class="btn btn-ghost" type="button">Mode clair</button>
+                </div>
             </div>
         </header>
-        
         <div class="layout">
             <div>
                 <div id="company-settings" class="card" style="margin-bottom:12px;display:none">
                     <h2 style="margin-top:0">Informations entreprise</h2>
                     <div class="row3">
                         <div><label>Nom</label><input id="c-name"/></div>
                         <div><label>Email</label><input id="c-email" type="email"/></div>
                         <div><label>Téléphone</label><input id="c-phone"/></div>
                     </div>
                     <div class="row3" style="margin-top:10px">
                         <div><label>Adresse</label><input id="c-address"/></div>
                         <div><label>SIREN</label><input id="c-siren"/></div>
                         <div><label>SIRET</label><input id="c-siret"/></div>
                     </div>
                     <div class="row3" style="margin-top:10px">
                         <div><label>RCS</label><input id="c-rcs"/></div>
                         <div><label>TVA</label><input id="c-tva"/></div>
                         <div><label>Assurance</label><input id="c-assurance"/></div>
                     </div>
                     <div style="margin-top:10px;text-align:right">
                         <button id="btn-save-company" class="btn btn-primary" type="button">Enregistrer</button>
                     </div>
                 </div>
                 <div class="stepper" id="stepper"></div>
                 
                 <div id="step-1" class="card">
                     <h2 style="margin-top:0">1) Infos chantier</h2>
                     <div class="row">
                         <div>
                             <label>Adresse (ville)</label>
-                            <input id="ville" placeholder="Montpellier, Béziers, Sète…"/>
+                            <input id="ville" list="ville-list" placeholder="Montpellier, Béziers, Sète…"/>
+                            <datalist id="ville-list"></datalist>
                         </div>
                         <div>
                             <label>Date souhaitée</label>
                             <input id="date" type="date"/>
                         </div>
                     </div>
                     
                     <div class="row3" style="margin-top:10px">
                         <div>
                             <label>Étage</label>
                             <input id="etage" type="number" min="0" value="0"/>
                             <div class="muted">0 = RDC</div>
                         </div>
                         <div>
                             <label>Ascenseur</label>
                             <select id="ascenseur">
                                 <option>Oui</option>
                                 <option>Non</option>
                             </select>
                         </div>
                         <div>
                             <label>Portage depuis stationnement (m)</label>
                             <input id="portage" type="number" min="0" value="10"/>
                         </div>
                     </div>
@@ -429,63 +462,63 @@
                     <div class="row3" style="margin-top:10px">
                         <div>
                             <label>Accès engins (camion, mini‑pelle, benne)</label>
                             <select id="engins">
                                 <option value="ok">Possible</option>
                                 <option value="limité">Limité</option>
                                 <option value="impossible">Impossible</option>
                             </select>
                         </div>
                         <div>
                             <label>Déchets à évacuer (m³)</label>
                             <input id="dechets" type="number" min="0" value="0"/>
                         </div>
                         <div>
                             <label>Complexité coordination</label>
                             <select id="complexite">
                                 <option value="basse">Basse</option>
                                 <option value="moyenne" selected>Moyenne</option>
                                 <option value="haute">Haute</option>
                             </select>
                         </div>
                     </div>
                 </div>
                 
                 <div id="step-2" class="card" style="margin-top:12px">
-                    <h2 style="margin-top:0">2) Métiers & tâches</h2>
+                    <h2 style="margin-top:0">2) Métiers &amp; tâches</h2>
                     <div class="grid-gap">
                         <div id="tasks"></div>
                         <div class="row">
                             <button id="add-task" class="btn btn-ghost" type="button">+ Ajouter une tâche</button>
                             <button id="add-manual-task" class="btn btn-ghost" type="button">+ Tâche libre</button>
                         </div>
                         <div class="muted">Sélectionnez un métier puis une tâche, ou ajoutez une tâche libre, puis indiquez la quantité.</div>
                     </div>
                 </div>
                 
                 <div id="step-3" class="card" style="margin-top:12px">
-                    <h2 style="margin-top:0">3) Options & TVA</h2>
+                    <h2 style="margin-top:0">3) Options &amp; TVA</h2>
                     <div class="row3">
                         <div>
                             <label>Urgence</label>
                             <select id="urgence">
                                 <option value="non">Non</option>
                                 <option value="oui">Oui (+10%)</option>
                             </select>
                         </div>
                         <div>
                             <label>Week‑end</label>
                             <select id="weekend">
                                 <option value="non">Non</option>
                                 <option value="oui">Oui (+25%)</option>
                             </select>
                     </div>
                     <div>
                         <label>Travail de nuit</label>
                         <select id="nuit">
                             <option value="non">Non</option>
                             <option value="oui">Oui (+20%)</option>
                         </select>
                     </div>
                 </div>
 
                 <div style="margin-top:10px">
@@ -532,115 +565,121 @@
                         </div>
                         <div>
                             <label>Email</label>
                             <input id="email" type="email" placeholder="vous@email.fr"/>
                         </div>
                         <div>
                             <label>Téléphone</label>
                             <input id="phone" type="tel" placeholder="06 12 34 56 78"/>
                         </div>
                     </div>
                     
                     <div style="margin-top:10px">
                         <label>Commentaire</label>
                         <textarea id="comment" rows="3" placeholder="Infos complémentaires, photos (lien), contraintes spécifiques…"></textarea>
                     </div>
                     
                     <div class="hr"></div>
                     
                     <div style="display:flex;gap:10px;flex-wrap:wrap">
                         <button id="btn-prev" class="btn btn-ghost" type="button">← Précédent</button>
                         <button id="btn-next" class="btn btn-primary" type="button">Voir le récapitulatif →</button>
                     </div>
                 </div>
                 
                 <div id="step-5" class="card" style="margin-top:12px;display:none">
-                    <h2 style="margin-top:0">5) Récapitulatif & envoi</h2>
+                    <h2 style="margin-top:0">5) Récapitulatif &amp; envoi</h2>
                     <div id="recap"></div>
                     <div class="hr"></div>
                     <div style="display:flex;gap:10px;flex-wrap:wrap">
                         <button id="btn-pdf" class="btn btn-ghost" type="button">Télécharger le devis</button>
                         <button id="btn-invoice" class="btn btn-ghost" type="button">Télécharger la facture</button>
-                        <button id="btn-send" class="btn btn-primary" type="button">Envoyer & être rappelé</button>
+                        <button id="btn-send" class="btn btn-primary" type="button">Envoyer &amp; être rappelé</button>
                         <button id="btn-edit" class="btn btn-ghost" type="button">← Modifier</button>
                         <button id="btn-archives" class="btn btn-ghost" type="button">Archives</button>
                     </div>
                     <p class="muted" style="margin-top:8px">En envoyant, vous acceptez d'être recontacté. Données stockées de façon sécurisée. Droit de rectification et suppression sur demande.</p>
                 </div>
             </div>
 
             <div id="archives" class="card" style="margin-top:12px;display:none">
                 <h2 style="margin-top:0">Archives</h2>
                 <ul id="archive-list"></ul>
             </div>
             
             <div class="card" aria-live="polite" aria-atomic="true">
                 <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                     <h2 style="margin:0">Estimation en temps réel</h2>
                     <span class="badge" id="count-tasks">0 tâche</span>
                 </div>
                 
                 <div class="row" style="margin-top:8px">
                     <div>
                         <div class="muted">Total estimatif HT</div>
                         <div class="price" id="total-ht">—</div>
                     </div>
                     <div>
                         <div class="muted">Total estimatif TTC</div>
                         <div class="price" id="total-ttc">—</div>
                     </div>
                 </div>
 
                 <div class="muted" style="margin-top:8px">Durée estimée : <span id="duration">—</span></div>
 
                 <table style="margin-top:10px">
                     <thead>
                         <tr>
                             <th>Détail</th>
                             <th class="right">HT</th>
                         </tr>
                     </thead>
                     <tbody id="rows"></tbody>
-                    <tfoot>
-                        <tr>
-                            <td class="total">Total HT</td>
-                            <td class="right total" id="f-total-ht">—</td>
-                        </tr>
-                        <tr>
-                            <td>TVA <span id="tva-rate">—</span></td>
-                            <td class="right" id="tva-amt">—</td>
-                        </tr>
+                    <tfoot>
+                        <tr>
+                            <td class="total">Total HT</td>
+                            <td class="right total" id="f-total-ht">—</td>
+                        </tr>
+                        <tr id="discount-row" style="display:none">
+                            <td>Remise commerciale</td>
+                            <td class="right" id="discount-amt"></td>
+                        </tr>
+                        <tr>
+                            <td>TVA <span id="tva-rate">—</span></td>
+                            <td class="right" id="tva-amt">—</td>
+                        </tr>
                         <tr>
                             <td class="total">Total TTC</td>
                             <td class="right total" id="f-total-ttc">—</td>
                         </tr>
                     </tfoot>
-                </table>
-                
-                <div class="alert" style="margin-top:12px">
-                    Estimation indicative. Visite technique et devis signé nécessaires pour valider prix, quantités et délais. TVA réduite sous conditions.
-                </div>
+                </table>
+
+                <div id="messages" class="alert" style="display:none;margin-top:12px"></div>
+
+                <div class="alert" style="margin-top:12px">
+                    Estimation indicative. Visite technique et devis signé nécessaires pour valider prix, quantités et délais. TVA réduite sous conditions.
+                </div>
                 
                 <div class="muted" style="margin-top:10px" id="company-legal"></div>
             </div>
         </div>
     </div>
 
     <script>
         document.addEventListener('DOMContentLoaded', function () {
         // Informations entreprise
         const DEFAULT_COMPANY = {
             name: 'SARL BRUNO MIRA',
             address: '34980 Combaillaux',
             phone: '04 xx xx xx xx',
             email: 'contact@exemple.fr',
             siren: '000 000 000',
             siret: '123 456 789 00010',
             rcs: 'XXX',
             tva: 'FRXX',
             insurance: 'RC & décennale n° XXXXX'
         };
         let company = { ...DEFAULT_COMPANY, ...JSON.parse(localStorage.getItem('company') || '{}') };
 
         // Configuration
         const CATALOG = {
             "Maçonnerie": [
@@ -1074,194 +1113,249 @@
                                 trade: trade,
                                 taskId: taskId,
                                 label: taskOption.textContent,
                                 unit: taskOption.dataset.unit,
                                 rate: parseFloat(taskOption.dataset.rate),
                                 min: parseFloat(taskOption.dataset.min),
                                 hours: parseFloat(taskOption.dataset.hours),
                                 qty: qty,
                                 tva55: taskOption.dataset.tva55 === '1',
                                 detail: detail
                             });
                         }
                     }
                 }
             });
 
             return result;
         }
 
         // Fonction de calcul des prix
         async function updatePricing() {
             const tasks = readTasks();
             let tasksTotal = 0;
             let totalHours = 0;
             const rows = [];
+            const tradeTotals = {};
+            const messages = [];
 
             // Taux de majoration appliqué aux tâches en fonction des options
             let optionRate = 0;
             if (byId('urgence').value === 'oui') optionRate += 0.10;
             if (byId('weekend').value === 'oui') optionRate += 0.25;
             if (byId('nuit').value === 'oui') optionRate += 0.20;
             const pack = byId('pack').value;
             if (pack === 'confort') optionRate += 0.12;
             else if (pack === 'premium') optionRate += 0.25;
 
             // Calcul du prix des tâches avec majoration éventuelle
             tasks.forEach(task => {
                 let price = 0;
 
                 switch (task.unit) {
                     case 'm²':
                     case 'ml':
                     case 'u':
                         price = task.rate * task.qty;
                         break;
                     case 'forfait':
                         price = task.rate * task.qty;
                         break;
                 }
 
                 // Appliquer le minimum
                 if (task.min) {
                     price = Math.max(price, task.min);
                 }
 
+                // Marge automatique
+                const marginRate = task.hours > 0 ? 0.30 : 0.15;
+                price *= (1 + marginRate);
+
                 // Répartir les options sur les tâches
                 price *= (1 + optionRate);
 
                 const hours = task.hours * task.qty;
                 totalHours += hours;
                 tasksTotal += price;
-                rows.push({ description: `${task.trade} — ${task.label}${task.detail ? ' — ' + task.detail : ''}`, qty: task.qty, unit: task.unit, price });
+                rows.push({ trade: task.trade, description: `${task.trade} — ${task.label}${task.detail ? ' — ' + task.detail : ''}`, qty: task.qty, unit: task.unit, price });
             });
 
             const baseTotal = tasksTotal;
             let siteRate = 0;
             let siteFixed = 0;
             const floor = parseInt(byId('etage').value) || 0;
             if (byId('ascenseur').value === 'Non') siteFixed += floor * FLOOR_COST_NO_ELEVATOR;
             siteFixed += (parseFloat(byId('portage').value) || 0) * PORTAGE_COST_PER_M;
             switch (byId('acces').value) {
                 case 'difficile': siteRate += 0.05; break;
             }
             switch (byId('stationnement').value) {
                 case 'moyen': siteRate += 0.02; break;
                 case 'difficile': siteRate += 0.05; break;
             }
             siteFixed += parseFloat(byId('parking_fees').value) || 0;
             switch (byId('engins').value) {
-                case 'limité': siteRate += 0.03; break;
-                case 'impossible': siteRate += 0.07; break;
+                case 'limité':
+                    siteRate += 0.03;
+                    messages.push('Attention, accès engins limité : +3 %');
+                    break;
+                case 'impossible':
+                    siteRate += 0.07;
+                    messages.push('Attention, engins non accessibles : +7 %');
+                    break;
             }
             siteFixed += (parseFloat(byId('dechets').value) || 0) * WASTE_COST_PER_M3;
             switch (byId('complexite').value) {
                 case 'moyenne': siteRate += 0.05; break;
                 case 'haute': siteRate += 0.10; break;
             }
             const siteExtra = siteFixed + baseTotal * siteRate;
             if (siteExtra > 0 && baseTotal > 0) {
                 rows.forEach(row => {
                     const share = (row.price / baseTotal) * siteExtra;
                     row.price += share;
                 });
                 tasksTotal += siteExtra;
             }
 
             // Durée estimée du chantier
             let workDays = totalHours / 7;
             const speed = byId('speed') ? byId('speed').value : 'normal';
             const speedFactor = speed === 'rapide' ? 0.8 : speed === 'lent' ? 1.2 : 1;
             workDays *= speedFactor;
             const days = totalHours > 0 ? Math.ceil(workDays) : 0;
 
             // Coût des trajets basé sur la durée réelle
             const distance = await getDistanceFromCity(byId('ville').value);
             const travelCost = distance * 2 * workDays * FUEL_COST_PER_KM;
             if (travelCost > 0 && tasksTotal > 0) {
                 rows.forEach(row => {
                     const share = (row.price / tasksTotal) * travelCost;
                     row.price += share;
                 });
                 tasksTotal += travelCost;
             }
 
+            rows.forEach(r => {
+                tradeTotals[r.trade] = (tradeTotals[r.trade] || 0) + r.price;
+            });
+
             let totalHT = tasksTotal;
 
+            // Remise commerciale automatique
+            const remiseThreshold = 10000;
+            const remiseRate = totalHT > remiseThreshold ? 0.05 : 0;
+            let remiseAmount = 0;
+            if (remiseRate > 0) {
+                remiseAmount = totalHT * remiseRate;
+                totalHT -= remiseAmount;
+                byId('discount-row').style.display = '';
+                byId('discount-amt').textContent = '-' + formatEUR(remiseAmount);
+            } else {
+                byId('discount-row').style.display = 'none';
+            }
+
             // TVA
             const tvaMode = byId('tva_mode').value;
             const logement2ans = byId('logement_2ans').checked;
             let tvaRate;
 
             if (tvaMode === 'auto') {
                 const all55 = tasks.length > 0 && tasks.every(t => t.tva55);
                 if (all55) {
                     tvaRate = 0.055;
                 } else if (logement2ans) {
                     tvaRate = 0.10;
                 } else {
                     tvaRate = 0.20;
                 }
             } else {
                 tvaRate = parseFloat(tvaMode) / 100;
             }
 
             const tvaAmount = totalHT * tvaRate;
             const totalTTC = totalHT + tvaAmount;
 
             pdfRows = rows.map(r => ({
                 description: r.description,
                 qty: r.qty,
                 unitPrice: r.price / (r.qty || 1),
                 total: r.price
             }));
+            Object.entries(tradeTotals).forEach(([trade, sum]) => {
+                pdfRows.push({ description: `Sous-total ${trade}`, qty: '', unitPrice: '', total: sum });
+            });
 
             // Mise à jour de l'affichage
             byId('total-ht').textContent = formatEUR(totalHT);
             byId('total-ttc').textContent = formatEUR(totalTTC);
             byId('f-total-ht').textContent = formatEUR(totalHT);
             byId('f-total-ttc').textContent = formatEUR(totalTTC);
             byId('tva-rate').textContent = `${(tvaRate * 100).toFixed(1).replace(/\.0$/, '')}%`;
             byId('tva-amt').textContent = formatEUR(tvaAmount);
             byId('count-tasks').textContent = `${tasks.length} ${tasks.length > 1 ? 'tâches' : 'tâche'}`;
             byId('duration').textContent = days > 0 ? `${days} ${days > 1 ? 'jours' : 'jour'}` : '—';
 
             // Mise à jour du tableau détaillé
             const rowsContainer = byId('rows');
             rowsContainer.innerHTML = '';
 
             rows.forEach(row => {
                 const tr = document.createElement('tr');
                 const td1 = document.createElement('td');
                 td1.textContent = `${row.description} (${row.qty} ${row.unit})`;
                 const td2 = document.createElement('td');
                 td2.className = 'right';
                 td2.textContent = formatEUR(row.price);
                 tr.appendChild(td1);
                 tr.appendChild(td2);
                 rowsContainer.appendChild(tr);
             });
+            Object.entries(tradeTotals).forEach(([trade, sum]) => {
+                const tr = document.createElement('tr');
+                tr.className = 'subtotal';
+                const td1 = document.createElement('td');
+                td1.className = 'total';
+                td1.textContent = `Sous-total ${trade}`;
+                const td2 = document.createElement('td');
+                td2.className = 'right total';
+                td2.textContent = formatEUR(sum);
+                tr.appendChild(td1);
+                tr.appendChild(td2);
+                rowsContainer.appendChild(tr);
+            });
+
+            const msgEl = byId('messages');
+            if (msgEl) {
+                if (messages.length) {
+                    msgEl.innerHTML = messages.join('<br>');
+                    msgEl.style.display = '';
+                } else {
+                    msgEl.style.display = 'none';
+                }
+            }
         }
 
         // Initialisation
         byId('add-task').addEventListener('click', addTaskRow);
         byId('add-manual-task').addEventListener('click', addManualTaskRow);
         const optionIds = ['urgence', 'weekend', 'nuit', 'speed', 'pack', 'tva_mode'];
         optionIds.forEach(id => {
             const el = byId(id);
             if (el) el.addEventListener('change', updatePricing);
         });
         const siteIds = ['etage', 'ascenseur', 'portage', 'acces', 'stationnement', 'parking_fees', 'engins', 'dechets', 'complexite'];
         siteIds.forEach(id => {
             const el = byId(id);
             if (el) {
                 el.addEventListener('change', updatePricing);
                 el.addEventListener('input', updatePricing);
             }
         });
         const logement2ansEl = byId('logement_2ans');
         if (logement2ansEl) logement2ansEl.addEventListener('change', updatePricing);
         const villeEl = byId('ville');
         if (villeEl) villeEl.addEventListener('input', updatePricing);
         addTaskRow();
 
         // Génération du récapitulatif
@@ -1288,56 +1382,64 @@
         // Navigation vers le récapitulatif
         const btnNext = byId('btn-next');
         if (btnNext) {
             btnNext.addEventListener('click', async function () {
                 await updatePricing();
                 buildRecap();
                 const step5 = byId('step-5');
                 step5.style.display = 'block';
                 step5.scrollIntoView({ behavior: 'smooth' });
             });
         }
         const btnEdit = byId('btn-edit');
         if (btnEdit) {
             btnEdit.addEventListener('click', function () {
                 byId('step-5').style.display = 'none';
                 byId('step-4').scrollIntoView({ behavior: 'smooth' });
             });
         }
 
         async function generatePdf(kind) {
             await updatePricing();
             buildRecap();
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
 
+            doc.setFontSize(16);
+            doc.text(byId('company-logo').textContent || 'LOGO', 14, 20);
+            if (kind === 'devis') {
+                doc.setFontSize(12);
+                doc.setTextColor(220, 38, 38);
+                doc.text('DEVIS PROVISOIRE', 150, 20);
+                doc.setTextColor(0, 0, 0);
+            }
             doc.setFont('helvetica', 'bold');
             doc.setFontSize(18);
             const title = kind === 'facture' ? 'FACTURE' : 'DEVIS';
-            doc.text(title, 105, 20, { align: 'center' });
+            doc.text(title, 105, 30, { align: 'center' });
 
-            let y = 30;
+            let y = 40;
             doc.setFontSize(12);
             doc.text('Informations Entreprise', 14, y);
             y += 6;
             doc.setFont('helvetica', 'normal');
             doc.text(`Entreprise : ${company.name}`, 14, y); y += 6;
             doc.text(`Adresse : ${company.address}`, 14, y); y += 6;
             doc.text(`Téléphone : ${company.phone}`, 14, y); y += 6;
             doc.text(`Email : ${company.email}`, 14, y); y += 6;
             doc.text(`SIREN : ${company.siren}`, 14, y); y += 6;
             doc.text(`SIRET : ${company.siret}`, 14, y); y += 6;
             doc.text(`RCS : ${company.rcs}`, 14, y); y += 6;
             doc.text(`TVA : ${company.tva}`, 14, y); y += 6;
             doc.text(`Assurance décennale : ${company.insurance}`, 14, y); y += 10;
 
             doc.setFont('helvetica', 'bold');
             doc.text('Informations Client', 14, y);
             y += 6;
             doc.setFont('helvetica', 'normal');
             doc.text(`Nom : ${byId('name').value}`, 14, y); y += 6;
             doc.text(`Adresse : ${byId('ville').value}`, 14, y); y += 6;
             doc.text(`Téléphone : ${byId('phone').value}`, 14, y); y += 10;
 
             const label = kind === 'facture' ? 'Facture' : 'Devis';
             doc.setFont('helvetica', 'bold');
             doc.text(`Détails ${kind === 'facture' ? 'de la' : 'du'} ${label}`, 14, y);
@@ -1361,50 +1463,54 @@
             doc.text(`Sous-total HT : ${byId('f-total-ht').textContent}`, 196, y, { align: 'right' });
             doc.text(`TVA (${byId('tva-rate').textContent}) : ${byId('tva-amt').textContent}`, 196, y + 7, { align: 'right' });
             doc.setFont('helvetica', 'bold');
             doc.setTextColor(220, 38, 38);
             doc.text(`Total TTC : ${byId('f-total-ttc').textContent}`, 196, y + 14, { align: 'right' });
             doc.setTextColor(0, 0, 0);
             y += 26;
 
             doc.setFont('helvetica', 'normal');
             doc.setFontSize(10);
 
             const addTextBlock = text => {
                 const lines = doc.splitTextToSize(text, 182);
                 doc.text(lines, 14, y);
                 y += lines.length * 5;
             };
 
             if (kind === 'devis') {
                 addTextBlock('Durée de validité du devis : 30 jours');
             }
             addTextBlock("Prix indiqué : sous réserve d'évolution du coût des matériaux, ajusté à la commande, selon stock et la livraison.");
             addTextBlock(`TVA applicable : ${byId('tva-rate').textContent}`);
             addTextBlock("Mention légale : 50% d'acompte à la commande, solde à la livraison.");
             addTextBlock('SRT légales : TVA applicable, RC Pro, coordonnées disponibles sur demande.');
 
+            addTextBlock('Signature :');
+            doc.line(40, y, 120, y);
+            y += 10;
+
             const dataUrl = doc.output('dataurlstring');
             saveArchive(kind, dataUrl);
             doc.save(`${kind}.pdf`);
         }
 
         function saveArchive(kind, dataUrl) {
             const archives = JSON.parse(localStorage.getItem('archives') || '[]');
             archives.push({ kind, dataUrl, date: new Date().toISOString() });
             localStorage.setItem('archives', JSON.stringify(archives));
         }
 
         function renderArchives() {
             const list = byId('archive-list');
             list.innerHTML = '';
             const archives = JSON.parse(localStorage.getItem('archives') || '[]');
             archives.forEach((a, i) => {
                 const li = document.createElement('li');
                 const link = document.createElement('a');
                 link.href = a.dataUrl;
                 link.download = `${a.kind}-${i + 1}.pdf`;
                 link.textContent = `${a.kind.toUpperCase()} - ${new Date(a.date).toLocaleString()}`;
                 li.appendChild(link);
                 list.appendChild(li);
             });
         }
@@ -1426,30 +1532,74 @@
                 if (arch.style.display === 'none') {
                     renderArchives();
                     arch.style.display = 'block';
                     arch.scrollIntoView({ behavior: 'smooth' });
                 } else {
                     arch.style.display = 'none';
                 }
             });
         }
 
         const btnCompany = byId('btn-company');
         if (btnCompany) {
             btnCompany.addEventListener('click', function () {
                 const cs = byId('company-settings');
                 cs.style.display = cs.style.display === 'none' ? 'block' : 'none';
             });
         }
         const btnSaveCompany = byId('btn-save-company');
         if (btnSaveCompany) {
             btnSaveCompany.addEventListener('click', function () {
                 saveCompany();
                 byId('company-settings').style.display = 'none';
             });
         }
 
+        const themeToggle = byId('theme-toggle');
+        if (themeToggle) {
+            const applyTheme = t => {
+                document.documentElement.setAttribute('data-theme', t);
+                themeToggle.textContent = t === 'dark' ? 'Mode clair' : 'Mode sombre';
+            };
+            applyTheme(localStorage.getItem('theme') || 'dark');
+            themeToggle.addEventListener('click', () => {
+                const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
+                localStorage.setItem('theme', current);
+                applyTheme(current);
+            });
+        }
+
+        const villeInput = byId('ville');
+        const villeList = byId('ville-list');
+        if (villeInput) {
+            let debounce;
+            villeInput.addEventListener('input', function () {
+                const q = this.value.trim();
+                if (debounce) clearTimeout(debounce);
+                if (q.length < 3) return;
+                debounce = setTimeout(async () => {
+                    try {
+                        const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&type=municipality&limit=5`);
+                        const data = await res.json();
+                        villeList.innerHTML = data.features.map(f => `<option value="${f.properties.label}"></option>`).join('');
+                    } catch (e) { }
+                }, 300);
+            });
+        }
+
+        const stepsEls = [1,2,3,4,5].map(n => byId(`step-${n}`));
+        const progressBarEl = byId('progress-bar');
+        function updateProgressBar() {
+            let current = 1;
+            stepsEls.forEach((el, i) => {
+                if (el.getBoundingClientRect().top <= 80) current = i + 1;
+            });
+            progressBarEl.style.width = (current / stepsEls.length) * 100 + '%';
+        }
+        document.addEventListener('scroll', updateProgressBar);
+        updateProgressBar();
+
         renderCompany();
         });
     </script>
 </body>
 </html>
